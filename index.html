<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>KANKAKUクエスト — あなたの感覚ジョブ診断</title>

  <!-- ===== OGP ===== -->
  <meta property="og:title" content="KANKAKUクエスト — あなたの感覚ジョブ診断">
  <meta property="og:description" content="7つの感覚（聴覚/視覚/触覚/嗅覚/味覚/温度・痛み/動き）を簡易チェック。称号とレーダーチャートを表示。">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://manakuronissy.github.io/">
  <meta property="og:image" content="https://manakuronissy.github.io/og/og-default.png">
  <meta property="og:site_name" content="KANKAKUクエスト">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="KANKAKUクエスト — あなたの感覚ジョブ診断">
  <meta name="twitter:description" content="称号とレーダーチャートで感覚の傾向を見える化。">
  <meta name="twitter:image" content="https://manakuronissy.github.io/og/og-default.png">

  <!-- 404回避の簡易favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%230f172a'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='84' fill='white'%3EQ%3C/text%3E%3C/svg%3E" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{ --bg:#f7f8fb; --card:#fff; --ink:#0f172a; --muted:#616b7c; --brand:#2563eb; --brand2:#0f172a; --ring:#e5e7eb; --good:#16a34a; --warn:#ea580c; }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%;text-size-adjust:100%;max-width:100%;overflow-x:hidden;}
    body{margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--ink); background:linear-gradient(#f7f8fb,#fff);max-width:100%;overflow-x:hidden;}
    img,svg,canvas,video{max-width:100%;height:auto;display:block}
    .seminar-banner{width:100%;height:auto;display:block}
    .container{max-width:960px; margin:0 auto; padding:16px}
    header{position:sticky; top:0; background:#ffffffbb; backdrop-filter:saturate(1.1) blur(6px); border-bottom:1px solid var(--ring)}
    header .bar{display:flex; align-items:center; justify-content:space-between; padding:10px 16px}
    .brand{display:flex; gap:10px; align-items:center; cursor:default; text-decoration:none; color:inherit}
    .brand .logo{width:32px;height:32px;border-radius:10px;background:var(--brand2);color:#fff;display:grid;place-items:center;font-weight:700}
    .button{border:1px solid var(--ring); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer}
    .button.primary{background:var(--brand); color:#fff; border-color:transparent}
    .button[disabled]{opacity:.5; cursor:not-allowed}
    .button.x  { background:#000;   color:#fff; border-color:#000 }
    .button.fb { background:#1877F2; color:#fff; border-color:#1877F2 }
    .button.line { background:#00B900; color:#fff; border-color:#00B900 }
    .grid{display:grid; gap:16px}
    .card{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:18px}
    .hero img{width:70%; max-width:800px; margin:0 auto; display:block}
    .progress{height:8px; background:#e5e7eb; border-radius:99px; overflow:hidden}
    .progress > div{height:100%; background:var(--brand2)}
    .likert{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:16px}
    .likert button{padding:10px 14px; border:1px solid var(--ring); border-radius:12px; transition:filter .15s ease}
    .likert button.active{outline:2px solid #facc15; border-color:#facc15}
    .likert .v0{ background:#e6f7ec; } .likert .v1{ background:#fff8db; }
    .likert .v2{ background:#ffefaf; } .likert .v3{ background:#fde68a; }
    .likert .v4{ background:#facc15; }
    .retry-button { background-color:#e53935; color:#fff; border:none; }
    .retry-button:hover { background-color:#c62828; }
    .cols{display:grid; gap:16px}
    @media(min-width:900px){.cols{grid-template-columns:repeat(3,1fr)}}
    .small{font-size:12px; color:#475569}
    .muted{color:#616b7c}
    .badge{display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background:#eef2ff}
    .badge.pr{ background:#fff1f2; color:#9f1239; border:1px solid #fecdd3; }
    .center{text-align:center}
    img.role{width:360px; height:auto; display:block; margin:8px auto 0; max-width:100%;}
    .level-display{font-size:20px; font-weight:700; margin-top:6px}
    .role-comment{margin-top:6px; color:#374151}
    footer{color:#6b7280; font-size:12px; padding:24px 16px}
    .cta{background:#f8fafc; border:1px solid #e2e8f0}
    .cta h3{ margin:0 0 6px; font-size:18px; }
    .cta .subtle{ color:#475569; font-size:13px; }
    .start-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; margin-top:12px}
    .share{display:grid; gap:10px; justify-items:center}
    .share .buttons{display:flex; flex-wrap:wrap; gap:8px; justify-content:center}
    .level-grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    @media(min-width:700px){.level-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .level-item{border:1px solid var(--ring); border-radius:12px; padding:10px; background:#fff}
    .level-item .lv{font-weight:700}
    .chip{display:inline-block; padding:2px 8px; font-size:12px; border-radius:999px; background:#f1f5f9; margin-left:6px}
    .disclaimer{margin-top:10px; font-size:12px; color:#64748b; line-height:1.6}
    #homeLink{pointer-events:none; cursor:default}
    .radar-wrap{height:360px; margin:14px auto 0; display:flex; align-items:center; justify-content:center; max-width:560px; width:100%;}
    .sticky-cta{ position:fixed; left:0; right:0; bottom:0; z-index:50; background:#0f172a; color:#fff; border-top:1px solid #1f2937; }
    .sticky-cta .row{display:flex; gap:12px; align-items:center; justify-content:center; padding:10px 12px; flex-wrap:wrap}
    .sticky-cta .close{position:absolute; right:12px; top:8px; background:transparent; color:#cbd5e1; border:none; font-size:18px; cursor:pointer}
    
    /* ===== TOP3（横並び＋小さめイラスト） ===== */
.top-jobs{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  align-items:start;
}
.top-jobs .job-card{
  border:1px solid var(--ring);
  border-radius:10px;
  padding:8px;
  background:#fff;
  text-align:center;
}
.top-jobs .job-card img{
  width:72px;
  height:auto;
  margin:4px auto 8px;
  display:block;
  border-radius:6px;
}
.top-jobs .title{ font-weight:700; font-size:14px; line-height:1.3 }
.top-jobs .lvl{ font-size:12px; color:#475569 }

/* ランク色（控えめ） */
.rank-1{ border-color:#f59e0b; background:#fffbeb; }
.rank-2{ border-color:#94a3b8; background:#f1f5f9; }
.rank-3{ border-color:#c084fc; background:#faf5ff; }

/* ===== レスポンシブ ===== */
/* タブレット以下: 2列 */
@media (max-width: 900px){
  .top-jobs{ grid-template-columns:repeat(2,1fr); }
  .top-jobs .job-card img{ width:68px; }
}
/* スマホ: 1列縦並び＋さらに小さく */
@media (max-width: 520px){
  .top-jobs{ grid-template-columns:1fr; }
  .top-jobs .job-card{
    display:grid;
    grid-template-columns:auto 1fr;
    gap:10px;
    text-align:left;
    align-items:center;
  }
  .top-jobs .job-card img{ width:56px; margin:0; }
  .top-jobs .title{ font-size:13px; }
  .top-jobs .lvl{ font-size:12px; }
}

    
    
    @media(max-width:480px){
      .container{padding:12px}
      header .bar{padding:8px 12px}
      .hero img{width:100%; max-width:none}
      h1,h2{font-size:20px}
      .card{padding:14px}
      img.role{width:68vw; max-width:280px}
      .level-display{font-size:16px}
      .role-comment{font-size:14px; line-height:1.6}
      .level-grid{grid-template-columns:1fr}
      .share .buttons .button{width:100%}
      .radar-wrap{height:300px; max-width:100%;}
      

}

  </style>
</head>
<body>
  <header>
    <div class="bar container">
      <a id="homeLink" class="brand" aria-label="KANKAKUクエスト">
        <div class="logo">Q</div><div style="font-weight:700">KANKAKUクエスト</div>
      </a>
    </div>
  </header>

  <main id="app" class="container"></main>

  <!-- スティッキー告知バー（結果画面で表示） -->
  <div id="stickyCta" class="sticky-cta" hidden>
    <button class="close" id="stickyClose" aria-label="閉じる">×</button>
    <div class="row">
      <div id="stickyMsg">8/23 オンラインセミナー まで <strong id="leftDays">7</strong> 日！</div>
      <a id="stickyBtn" class="button primary" target="_blank">申し込み（無料）</a>
    </div>
  </div>

  <footer class="container">
    <div style="margin-bottom:6px;">by <strong>MANAKURO</strong></div>
    プライバシー：回答は端末内で処理され、同意なく保存されません。
  </footer>

  <script>
    /* ================= 設定 ================= */
    const SEMINAR_DATE = '2025-08-23';
    const SEMINAR_URL  = 'https://forms.gle/hWcV6LZDvR2S9wX88';
    const QUESTION_COUNT = 28;
    const DUAL_THRESHOLD = 60;

    // 画像パス
    const IMAGES = {
      title: 'images/title-image.png',
      rolesHyper: {
        hearing:'images/job-elf-scout.png', vision:'images/job-wizard.png', touch:'images/job-guardian.png',
        smell:'images/job-poison-appraiser.png', taste:'images/job-gourmet.png', tempPain:'images/job-weather-mage.png',
        movement:'images/job-knight.png'
      },
      rolesHypo: {
        hearing:'images/job-hearing-hypo.png', vision:'images/job-vision-hypo.png', touch:'images/job-touch-hypo.png',
        smell:'images/job-smell-hypo.png', taste:'images/job-taste-hypo.png', tempPain:'images/job-tempPain-hypo.png',
        movement:'images/job-movement-hypo.png'
      },
      balanced: 'images/job-nomal.png',
      dual: 'images/job-dualblade.png'
    };

    const TITLES = {
      hyper: {
        hearing:{t:'エルフ耳の斥候（スカウト）', role:'スカウト'},
        vision:{t:'洞察の魔法使い（メイジ）', role:'メイジ'},
        touch:{t:'結界の守護者（ガーディアン）', role:'ガーディアン'},
        smell:{t:'毒の鑑定士（アルケミスト）', role:'アルケミスト'},
        taste:{t:'美食の王子／姫（グルメ）', role:'グルメ'},
        tempPain:{t:'気候予報士（メイジ）', role:'メイジ'},
        movement:{t:'揺れセンサー搭載者（ナイト）', role:'ナイト'}
      },
      hypo: {
        hearing:{t:'戦場の鼓手（バード）', role:'バード'},
        vision:{t:'月影のハンター（ハンター）', role:'ハンター'},
        touch:{t:'鉄皮のモンク（モンク）', role:'モンク'},
        smell:{t:'炉心の鍛冶師（ブラックスミス）', role:'ブラックスミス'},
        taste:{t:'香辛の冒険家（エクスプローラー）', role:'エクスプローラー'},
        tempPain:{t:'四季渡りのノマド（ノマド）', role:'ノマド'},
        movement:{t:'竜騎のランサー（ドラグーン）', role:'ドラグーン'}
      },
      dual:{ any:{ t:'感覚の双剣士（デュアルブレード）', role:'デュアルブレード' } },
      normal:{ any:{ t:'バランス型：ノーマライザー', role:'ノーマライザー' } }
    };

    const ROLE_COMMENTS = {
      hyper: {
        hearing:'小さな音も聞き逃さない探索の達人。静寂の守護者。',
        vision:'光や動きの変化を見抜く鋭視のメイジ。隠し扉もお手の物。',
        touch:'風や布の質感まで察知する触覚の盾。心地よい装備選びの達人。',
        smell:'香りで世界を読み解く鑑定士。危険信号も素早くキャッチ。',
        taste:'味の物語を読み解く舌。料理は芸術、素材の個性は正直に。',
        tempPain:'温度や痛みの変化を即察知。環境センサーで仲間を守る。',
        movement:'わずかな揺れも見逃さない守護騎士。空と海の旅は慎重派。'
      },
      hypo: {
        hearing:'雑踏でも落ち着いて動ける耳のタフネス。嵐でも冷静。',
        vision:'薄暗い道も慌てない夜の狩人。洞窟探索は任せて。',
        touch:'衝撃にも動じない武闘僧。険しい道も踏破する持久力。',
        smell:'香りの渦中でも集中を切らさない職人肌。作業に没頭できる。',
        taste:'未知の料理に果敢に挑む冒険胃袋。刺激も楽しめる。',
        tempPain:'気候変化にタフなノマド。暑さ寒さに振り回されにくい。',
        movement:'回転や加速も面白がる空の戦士。スピードの相棒。'
      },
      dual:'二つの感覚の刃を携え、あらゆる刺激に挑む戦術家。',
      balanced:'どんな環境でもマイペース。感覚の調律に長けたバランス職人。'
    };

    const AXES = [
      { key:'hearing',  label:'聴覚' },
      { key:'vision',   label:'視覚' },
      { key:'touch',    label:'触覚' },
      { key:'smell',    label:'嗅覚' },
      { key:'taste',    label:'味覚' },
      { key:'tempPain', label:'温度/痛み' },
      { key:'movement', label:'動き' }
    ];

// === 拡散向けコピー設定 ===
const FUNNY_COPY_ON = true; // ←面白コメントの自動追加をON/OFFできるトグル
const SHARE_HASH = '#KANKAKUクエスト #感覚ジョブ診断 #発達障害';

    // === 軽めのファンタジー寄り一言（配慮を保つ） ===
const FUN_LINES = {
  balanced: '今日はバランス型。状況対応力に+3のバフ。',
  dual:     '場面で切り替わる“二刀流”。使い分けが勝利の鍵。',
  hearing: {
    hyper: '静寂センサー感度UP。ノイズ対策で一気に快適。',
    hypo:  '雑踏でもマイペース。ドラム隊の心臓を持つ人。'
  },
  vision: {
    hyper: '細部まで見抜く“鷹の目”。光量ダウンでMP節約。',
    hypo:  '暗所に強い夜目タイプ。要点マーキングが相棒。'
  },
  touch: {
    hyper: '素材判定Sランク。タグカットでストレス回避。',
    hypo:  '圧で落ち着くタンク型。小キズチェックを忘れずに。'
  },
  smell: {
    hyper: '香りの鑑定士。換気とマスクで快適ゾーンを確保。',
    hypo:  '強い香りも動じない職人肌。期限表示は相棒。'
  },
  taste: {
    hyper: '味の書記官。食感と香りの微調整で世界が広がる。',
    hypo:  '刺激に強い冒険胃袋。バランス表で安定化。'
  },
  tempPain: {
    hyper: '環境センサー鋭敏。重ね着＆こまめ休憩で持久戦◎。',
    hypo:  '気候タフネス持ち。水分と客観温度で安全確保。'
  },
  movement: {
    hyper: '揺れ検知A。視点固定で酔い耐性アップ。',
    hypo:  'スピード仲良し。安全ルールで楽しく攻略。'
  }
};
    
    /* ================ 質問 ================ */
    const BANK = [
      // 聴覚
      { id:'h_h_1', axis:'hearing', trait:'hyper', adult:'店内やオフィスのざわめきで集中が途切れやすい' },
      { id:'h_h_2', axis:'hearing', trait:'hyper', adult:'突然の大きな音が苦手で、体が強く反応してしまう' },
      { id:'h_y_1', axis:'hearing', trait:'hypo',  adult:'雑音の中で呼ばれても気づきにくい' },
      { id:'h_y_2', axis:'hearing', trait:'hypo',  adult:'にぎやかな場所で小さな音に気づくのが遅れがち' },
      // 視覚
      { id:'v_h_1', axis:'vision', trait:'hyper', adult:'強い照明や画面の光がつらく、遮光したくなる' },
      { id:'v_h_2', axis:'vision', trait:'hyper', adult:'画面のちらつきや速い動きに疲れやすい' },
      { id:'v_y_1', axis:'vision', trait:'hypo',  adult:'部屋が暗くなったことに気が付きにくい' },
      { id:'v_y_2', axis:'vision', trait:'hypo',  adult:'画面や印刷の細かい違いに気づきにくい' },
      // 触覚
      { id:'t_h_1', axis:'touch', trait:'hyper', adult:'チクチクする服やタグが苦手' },
      { id:'t_h_2', axis:'touch', trait:'hyper', adult:'手や服のベタつきが気になる' },
      { id:'t_y_1', axis:'touch', trait:'hypo',  adult:'ぎゅっとした圧があると落ち着く' },
      { id:'t_y_2', axis:'touch', trait:'hypo',  adult:'軽い擦り傷にすぐ気づきにくい' },
      // 嗅覚
      { id:'s_h_1', axis:'smell', trait:'hyper', adult:'香水や柔軟剤のにおいが強く感じられて離れたくなる' },
      { id:'s_h_2', axis:'smell', trait:'hyper', adult:'料理のにおいが混ざる場所が苦手' },
      { id:'s_y_1', axis:'smell', trait:'hypo',  adult:'香りの強弱の差を感じ取りにくい' },
      { id:'s_y_2', axis:'smell', trait:'hypo',  adult:'食品の傷みのにおいに気づくのが遅れがち' },
      // 味覚
      { id:'ta_h_1', axis:'taste', trait:'hyper', adult:'繊細な味の違いがわかり、好みがはっきりしている' },
      { id:'ta_h_2', axis:'taste', trait:'hyper', adult:'食感や香りが合わないと食べづらい' },
      { id:'ta_y_1', axis:'taste', trait:'hypo',  adult:'濃い味やスパイスの強い料理を求める' },
      { id:'ta_y_2', axis:'taste', trait:'hypo',  adult:'新しい味の刺激を強く求める' },
      // 温度/痛み
      { id:'tp_h_1', axis:'tempPain', trait:'hyper', adult:'室温のわずかな変化が気になる' },
      { id:'tp_h_2', axis:'tempPain', trait:'hyper', adult:'小さな痛みでも集中が切れやすい' },
      { id:'tp_y_1', axis:'tempPain', trait:'hypo',  adult:'暑さ寒さに気づくのが遅れがち' },
      { id:'tp_y_2', axis:'tempPain', trait:'hypo',  adult:'軽いケガでも痛みをあまり感じない' },
      // 動き
      { id:'m_h_1', axis:'movement', trait:'hyper', adult:'人混みや揺れで酔いやすい' },
      { id:'m_h_2', axis:'movement', trait:'hyper', adult:'急な動きや加速が苦手' },
      { id:'m_y_1', axis:'movement', trait:'hypo',  adult:'スピードや回転の刺激を強く好む' },
      { id:'m_y_2', axis:'movement', trait:'hypo',  adult:'刺激を求めて走ったりジャンプしたくなる' }
    ];

    const LIKERT_WEIGHT = {0:0.00, 1:0.08, 2:0.28, 3:0.65, 4:1.00};
    const LIKERT = [
      { v:0, label:'あてはまらない' },
      { v:1, label:'すこしあてはまる' },
      { v:2, label:'ときどきあてはまる' },
      { v:3, label:'よくあてはまる' },
      { v:4, label:'とてもあてはまる' }
    ];

    let qs = []; let answers = {}; let index = 0;
    let moving = false;
    const app = document.getElementById('app');

    const baseURL = () => location.origin + location.pathname.replace(/index\.html$/,'');

    /* ===== START画面 ===== */
    function renderStart(){
      app.innerHTML = `
        <div class="grid">
          <div class="card hero"><img src="${IMAGES.title}" alt="KANKAKUクエスト タイトル"></div>
          <div class="card" style="text-align:center">
            <h1>あなたの感覚ジョブ診断</h1>
            <p class="muted">
              7つの感覚（聴覚/視覚/触覚/嗅覚/味覚/温度/痛み/動き）を<br>
              28問でさくっとチェック。結果は画像保存してシェアOK！
            </p>
            <div class="start-actions">
              <button class="button primary" id="startBtn">診断をスタート</button>
            </div>
          </div>
        </div>`;
      document.getElementById('startBtn').onclick = startQuestions;
      hideSticky();
      window.scrollTo(0,0);
    }

    function startQuestions(){
      qs = pickQuestions(QUESTION_COUNT);
      answers = {}; index = 0; moving = false;
      renderQuestion();
    }

    function renderQuestion(){
      const total = qs.length;
      const q = qs[index];
      const answered = answers[q.id];
      const progress = Math.round(Object.keys(answers).length/total*100);
      app.innerHTML = `
        <div class="grid">
          <div class="progress"><div style="width:${progress}%"></div></div>
          <div class="card" style="text-align:center">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px">
              <div><span class="badge">${getAxisLabel(q.axis)}</span></div>
              <div class="small">${index+1} / ${total}</div>
            </div>
            <div style="font-size:18px; margin-bottom:20px">${q.adult}</div>
            <div class="likert" id="likert" role="radiogroup"></div>
            <div style="display:flex; justify-content:space-between; margin-top:14px">
              <button class="button" id="prevBtn" ${index===0?'disabled':''}>もどる</button>
              <span class="small muted">タップで次へ</span>
            </div>
          </div>
        </div>`;
      const wrap = document.getElementById('likert');

      LIKERT.forEach((o, idx)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = o.label;
        btn.className = 'button v'+o.v;
        btn.setAttribute('role','radio');
        const isOn = answered===o.v;
        if(isOn) btn.classList.add('active');
        btn.setAttribute('aria-checked', isOn ? 'true' : 'false');
        btn.tabIndex = isOn || (answered==null && idx===0) ? 0 : -1;

        btn.onclick = ()=> selectAndNext(o.v);
        btn.onkeydown = (e)=>{
          if (e.key==='ArrowRight' || e.key==='ArrowDown'){ e.preventDefault(); (btn.nextElementSibling || wrap.firstElementChild).focus(); }
          else if (e.key==='ArrowLeft' || e.key==='ArrowUp'){ e.preventDefault(); (btn.previousElementSibling || wrap.lastElementChild).focus(); }
          else if (e.key===' ' || e.key==='Enter'){ e.preventDefault(); selectAndNext(o.v); }
        };
        wrap.appendChild(btn);
      });

      document.getElementById('prevBtn').onclick = ()=>{ if(index>0){ index--; renderQuestion(); } };
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function selectAndNext(value){
      if (moving) return;
      moving = true;
      const q = qs[index];
      answers[q.id] = value;
      const total = qs.length;
      if(index+1 < total){
        index++;
        setTimeout(()=>{ renderQuestion(); moving=false; }, 10);
      } else {
        setTimeout(()=>{ renderResult(); moving=false; }, 0);
      }
    }

    /* ===== 結果画面 ===== */
    function renderResult(){
      const s = calcScores(qs, answers);
      const { radar, overall, dominant, maxAny, lvDominant, lvBalanced, lvDual } = s;

      let finalType = overall.type;
      const dualAxes = s.dualAxes;
      if (maxAny < 60) finalType = 'balanced';
      else if (dualAxes.length > 0) finalType = 'dual';

      let titleObj = null, axisLabel = null, roleImg = null, level = null, levelLabel = 'レベル';
      if (finalType === 'balanced') {
        titleObj = { t:'バランス型：ノーマライザー', role:'ノーマライザー' };
        axisLabel = 'バランス型'; roleImg = IMAGES.balanced; level = lvBalanced; levelLabel='レベル（バランス度）';
      } else if (finalType === 'dual') {
        titleObj = TITLES.dual.any; axisLabel = '両極端'; roleImg = IMAGES.dual; level = lvDual;
      } else {
        const axis = AXES.find(a=>a.key===dominant);
        axisLabel = axis ? axis.label : '';
        titleObj = TITLES[overall.type][dominant];
        roleImg = (overall.type==='hyper') ? IMAGES.rolesHyper[dominant] : IMAGES.rolesHypo[dominant];
        level = lvDominant;
      }

      const headNote =
        finalType==='balanced' ? '今回は大きな偏りは見つかりませんでした。状況や体調によって感じ方がゆるやかに変わる、柔軟タイプかもしれません。' :
        finalType==='dual'     ? '過敏と鈍麻の両方が高く出ました。場面に応じて反応が切り替わるタイプかもしれません。使い分けの工夫が鍵です。' :
        `いちばん強く特徴が出たのは「${axisLabel}」。全体としては<strong>${overall.type==='hyper'?'過敏':'鈍麻'}</strong>の傾向がやや高めでした。`;

      const roleComment =
        finalType==='balanced' ? ROLE_COMMENTS.balanced :
        finalType==='dual'     ? ROLE_COMMENTS.dual :
        ROLE_COMMENTS[overall.type][dominant];

      app.innerHTML = `
        <div class="grid">
          <div class="card center">
            <h2>感覚クエスト⚔️診断結果</h2>
            <div class="muted">${headNote}</div>
            ${roleImg ? `<img class="role" src="${roleImg}" alt="${titleObj.t}">` : ``}
            <div style="font-weight:700; margin-top:6px">称号：${titleObj.t}</div>
            <div class="level-display">${levelLabel}：<span>Lv${String(level).padStart(2,'0')}</span>　ジョブ：${titleObj.role}</div>
            <div class="role-comment">${roleComment}</div>
            <div class="radar-wrap"><canvas id="radar"></canvas></div>
            <div class="disclaimer">
              ※ この結果は自己回答に基づく<strong>簡易チェック</strong>です。<br>
              医学的な診断・評価の提供を目的としたものではありません。体調や生活に困りごとがある場合は、医療・専門機関等へご相談ください。
            </div>
          </div>

 ${ renderTopJobs(s.radar) }

          <div class="card">
            <h3>各特性のレベル</h3>
            <div class="level-grid">
              ${renderAxisLevelBadges(s.radar)}
            </div>
          </div>

          ${ finalType==='balanced' && s.maxAny<25 ? renderLowOverallCard() : renderAxisFeedback(s.radar) }

<!-- 全職業のレベル（折りたたみ） -->
<div class="card" id="allJobsCard">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
    <h3 style="margin:0">全職業のレベル</h3>
    <button class="button" id="toggleJobs">一覧を表示</button>
  </div>
  <div id="jobsPanel" hidden style="margin-top:10px">
    <div id="jobsTopNote" class="small muted" style="margin-bottom:6px"></div>
    <div id="jobsList" class="level-grid"></div>
  </div>
</div>

          <div class="card share">
            <div style="font-weight:700;">結果をシェアしてイベントを応援しよう！</div>
            <div class="buttons" style="margin-top:6px">
              <button id="shareX" class="button x">X でシェア</button>
              <button id="shareLine" class="button line">LINEで送る</button>
              <button id="shareFB" class="button fb">Facebook</button>
              <button id="copyLink" class="button">リンクをコピー</button>
            </div>
            <div class="small muted" style="text-align:center">
              まずは「結果を画像保存（PNG）」→画像つきで投稿が伸びます。
            </div>
            <div style="margin-top:10px; text-align:center">
              <button id="savePngBtn" class="button">結果を画像保存（PNG）</button>
            </div>
            <div style="margin-top:8px; text-align:center">
              <button id="retryBtn" class="button retry-button">もう一度調べる</button>
            </div>
          </div>

          <div class="card cta" aria-label="関連イベントのお知らせ">
            <div style="display:grid; gap:16px; grid-template-columns:1fr; align-items:start">
              <div class="subtle"><span class="badge pr">PR</span> 関連イベント</div>
              <img class="seminar-banner" src="images/0823seminar.png" alt="オンラインセミナー 8/23 バナー">
              <div>
                <h3>保護者向け｜感覚過敏の子・不登校の子を支える具体策（${SEMINAR_DATE} オンライン）</h3>
                <p class="subtle">診断結果（<strong>称号：${titleObj.t}</strong> / Lv${String(level).padStart(2,'0')}）に合わせて、日常の「しんどい」を軽くするヒントをお届けします。</p>
                <div style="margin-top:10px">
                  <a id="seminarBtn" class="button primary" target="_blank">申し込みページ（Googleフォーム）</a>
                </div>
              </div>
            </div>
          </div>
        </div>`;

      // レーダーチャート
      const ctx = document.getElementById('radar');
      if (window.Chart && ctx) {
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: s.radar.map(d=>d.axis),
            datasets: [
              { label:'過敏', data: s.radar.map(d=>d.hyper), fill:true, borderColor:'#111827', backgroundColor:'rgba(17,24,39,0.35)' },
              { label:'鈍麻', data: s.radar.map(d=>d.hypo),  fill:true, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.25)' }
            ]
          },
          options: {
            responsive:true, maintainAspectRatio:false,
            scales:{ r:{
              suggestedMin:0, suggestedMax:100,
              ticks:{display:false},
              pointLabels:{ font:{ size:(window.matchMedia('(max-width:480px)').matches ? 12 : 13) } }
            }},
            plugins:{ legend:{
              position:'bottom',
              labels:{ boxWidth:12, boxHeight:12, font:{ size:(window.matchMedia('(max-width:480px)').matches ? 12 : 13) } }
            }}
          }
        });
      }

      // 共有文
      const shareText = buildShareText({
        title: titleObj.t, level, finalType, overallType: overall.type, dominant
      });

      // セミナーURL（UTM付き）
      const utm = new URLSearchParams({
        utm_source: 'kankakuquest', utm_medium: 'result', utm_campaign: 'seminar', utm_content: finalType
      }).toString();
      const seminarUrl = `${SEMINAR_URL}?${utm}`;
      const seminarBtn = document.getElementById('seminarBtn');
      if (seminarBtn) seminarBtn.href = seminarUrl;

      // シェア導線
document.getElementById('shareX').onclick = ()=>{
  // 共有テキスト（ハッシュタグは含めない想定）
  const t = encodeURIComponent(shareText);

  // 共有URL（あなたのページ）— OGPが出ます
  const u = encodeURIComponent(baseURL());

  // ハッシュタグはパラメータで渡すと字数節約＆見た目が綺麗
  const hashtags = encodeURIComponent('KANKAKUクエスト,感覚ジョブ診断,イベント告知');

  window.open(`https://x.com/intent/tweet?text=${t}&url=${u}&hashtags=${hashtags}`, '_blank');
};
      document.getElementById('shareFB').onclick = ()=>{
        const u = encodeURIComponent(baseURL());
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${u}`,'_blank');
      };
      document.getElementById('shareLine').onclick = ()=>{
        const txt = encodeURIComponent(shareText + '\n' + baseURL());
        window.open(`https://line.me/R/msg/text/?${txt}`,'_blank');
      };
      document.getElementById('copyLink').onclick = async ()=>{
        try{
          await navigator.clipboard.writeText(baseURL());
          alert('リンクをコピーしました！');
        }catch(e){ alert('コピーに失敗しました…'); }
      };

// PNG保存（TOP3も画像に入れる）
const saveBtn = document.getElementById('savePngBtn');
if (saveBtn) {
  const top3 = s.radar
    .map(chooseJobForAxis)
    .sort((a,b)=> b.score - a.score)
    .slice(0,3);

  saveBtn.onclick = () => saveResultPng({
    title: titleObj.t,
    level,
    roleImgSrc: roleImg,
    chartCanvasId: 'radar',
    top3,                       // 画像にTOP3を入れる
    pageUrl: baseURL(),         // 画像下フッタのURL
    hashtags: 'KANKAKUクエスト / 感覚ジョブ診断',
  });
}

      document.getElementById('retryBtn').onclick = () => { qs=[]; answers={}; index=0; renderStart(); };

      // スティッキー告知バー
      showSticky(seminarUrl);

// --- 全職業レベル 初期化 ---
const jobs = buildJobLevels(s.radar);
const jobsBtn = document.getElementById('toggleJobs');
const jobsPanel = document.getElementById('jobsPanel');
const jobsList = document.getElementById('jobsList');
const jobsTopNote = document.getElementById('jobsTopNote');

// 上位5件の要約文
if (jobsTopNote){
  const top5 = jobs.slice(0,5).map(j=> `${j.role} (Lv${String(j.level).padStart(2,'0')})`);
  jobsTopNote.textContent = '上位: ' + top5.join(' / ');
}

// 一覧（全件）
if (jobsList){
  jobsList.innerHTML = jobs.map(j=>{
    const chip = (j.mode==='hyper' ? '過敏' : '鈍麻');
    return `
      <div class="level-item">
        <div><strong>${j.title}</strong>
          <span class="chip">${j.axis}・${chip}</span>
        </div>
        <div class="lv">Lv${String(j.level).padStart(2,'0')}</div>
      </div>
    `;
  }).join('');
}

// 折りたたみ
if (jobsBtn && jobsPanel){
  jobsBtn.onclick = ()=>{
    const on = jobsPanel.hidden;
    jobsPanel.hidden = !on;
    jobsBtn.textContent = on ? '一覧を非表示' : '一覧を表示';
  };
}

      
      window.scrollTo({top:0, behavior:'smooth'});
    }

    /* ===== 小関数 ===== */
    function getAxisLabel(key){
      for (let i=0;i<AXES.length;i++){
        if (AXES[i].key === key) return AXES[i].label;
      }
      return '';
    }

    /* ===== シェア文（配慮＋ちょい遊び） ===== */
function buildShareText({ title, level, finalType, overallType, dominant }){
  // 面白コメントを切り替え可能
  if (!FUNNY_COPY_ON){
    const axisLabel = getAxisLabel(dominant);
    const head = '【感覚クエスト⚔️診断結果】';
    const lv = 'Lv' + String(level).padStart(2,'0');
    let tendency = '';
    if (finalType === 'dual') {
      tendency = '過敏と鈍麻の“両極端”タイプ！';
    } else if (finalType === 'balanced') {
      tendency = '今回は偏り少なめのバランス型！';
    } else {
      tendency = (axisLabel ? axisLabel : '') + (overallType === 'hyper' ? '過敏' : '鈍麻') + 'がやや高め。';
    }
    return head + '\n' +
  '称号「' + title + '」 ' + lv + '\n' +
  tendency + '\n' +
  (hashtags || SHARE_HASH);
  }

  const head = '【感覚クエスト⚔️診断結果】';
  const lv = 'Lv' + String(level).padStart(2,'0');
  const axisLabel = getAxisLabel(dominant);

  // ①中立の傾向文（配慮寄り）
  let tendency = '';
  if (finalType === 'dual') {
    tendency = '過敏と鈍麻の“両極端”タイプ！';
  } else if (finalType === 'balanced') {
    tendency = '今回は偏り少なめのバランス型！';
  } else {
    tendency = (axisLabel ? axisLabel : '') + (overallType === 'hyper' ? '過敏' : '鈍麻') + 'がやや高め。';
  }

  // ②軽いファンタジー寄り一言（状況改善のヒント系）
  let fun = '';
  if (finalType === 'balanced') {
    fun = FUN_LINES.balanced;
  } else if (finalType === 'dual') {
    fun = FUN_LINES.dual;
  } else if (FUN_LINES[dominant] && FUN_LINES[dominant][overallType]) {
    fun = FUN_LINES[dominant][overallType];
  }

  // ③ゆるいCTA（参加/共感を促すが強制しない）
  const cta = 'あなたは何タイプ？';

  // 仕上げ（280文字対策で短文を積む）
  // URLはX共有側で別途つけてもOKですが、現状はテキストのみなのでここでは付けません。
  return [
    head,
    '称号「' + title + '」 ' + lv,
    tendency,
    fun ? '— ' + fun : '',
    cta,
    SHARE_HASH
  ].filter(Boolean).join('\n');
}


function renderAxisLevelBadges(radar){
  // 強い順に並べ替え（各軸の max(hyper,hypo)）
  const ordered = radar
    .map(d => ({...d, maxScore: Math.max(d.hyper, d.hypo)}))
    .sort((a,b) => b.maxScore - a.maxScore);

  return ordered.map(d=>{
    const mode = d.hyper>d.hypo ? '過敏' : (d.hypo>d.hyper ? '鈍麻' : '同程度');
    const lv = pctToLv(Math.max(d.hyper, d.hypo));
    return `
      <div class="level-item">
        <div><strong>${d.axis}</strong><span class="chip">${mode}</span></div>
        <div class="lv">Lv${String(lv).padStart(2,'0')}</div>
      </div>
    `;
  }).join('');
}

    function pickQuestions(count){
      const byAxis = Object.fromEntries(AXES.map(a=>[a.key,{hyper:[],hypo:[]}]));
      BANK.forEach(q => byAxis[q.axis][q.trait].push(q));
      const picked = [];
      AXES.forEach(ax=>{
        const H = shuffle(byAxis[ax.key].hyper).slice(0,2);
        const Y = shuffle(byAxis[ax.key].hypo ).slice(0,2);
        picked.push(...H, ...Y);
      });
      return shuffle(count ? picked.slice(0, count) : picked);
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    // p=0–100 → Lv=0–99（少し緩やか）
    const pctToLv = p => Math.min(99, Math.max(0, Math.floor(Math.pow(p/100, 1.15) * 99)));

    function calcScores(questions, answers){
      const sums = Object.fromEntries(AXES.map(a=>[a.key,{h:0,y:0,hc:0,yc:0}]));
      questions.forEach(q=>{
        const v = answers[q.id];
        if(v==null) return;
        const key = String(v);
        const w = Object.prototype.hasOwnProperty.call(LIKERT_WEIGHT, key) ? LIKERT_WEIGHT[key] : 0;
        if(q.trait==='hyper'){sums[q.axis].h += w; sums[q.axis].hc++;}
        else                 {sums[q.axis].y += w; sums[q.axis].yc++;}
      });

      const radar = AXES.map(ax=>{
        const maxH = Math.max(1, sums[ax.key].hc * 1.0);
        const maxY = Math.max(1, sums[ax.key].yc * 1.0);
        const hyper = Math.round((sums[ax.key].h / maxH) * 100);
        const hypo  = Math.round((sums[ax.key].y / maxY) * 100);
        return { axis: ax.label, axisKey: ax.key, hyper, hypo };
      });

      const hyperAvg = Math.round(radar.reduce((a,d)=>a+d.hyper,0)/radar.length);
      const hypoAvg  = Math.round(radar.reduce((a,d)=>a+d.hypo,0)/radar.length);
      const maxAny   = Math.max(...radar.map(d=>Math.max(d.hyper,d.hypo)));
      const maxHyper = Math.max(...radar.map(d=>d.hyper));
      const maxHypo  = Math.max(...radar.map(d=>d.hypo));

      const dualAxes = radar.filter(d=> d.hyper>=DUAL_THRESHOLD && d.hypo>=DUAL_THRESHOLD).map(d=>d.axisKey);

      const overallType = (hyperAvg >= hypoAvg) ? 'hyper' : 'hypo';

      let dominantKey = radar[0].axisKey, best=-1;
      radar.forEach(d=>{ const m=Math.max(d.hyper,d.hypo); if(m>best){best=m; dominantKey=d.axisKey;} });

      const dom = radar.find(r=>r.axisKey===dominantKey);
      const lvDominant = pctToLv(Math.max(dom.hyper, dom.hypo));
      const lvBalanced = pctToLv(100 - maxAny);
      const lvDual     = pctToLv(Math.min(maxHyper, maxHypo));

      return { radar, hyperAvg, hypoAvg, maxAny, maxHyper, maxHypo,
               overall:{ type:overallType }, dominant:dominantKey,
               lvDominant, lvBalanced, lvDual, dualAxes };
    }

// 各軸の「過敏/鈍麻」を職業レベルに展開（一覧用）
function buildJobLevels(radar){
  // radar: [{axis:'聴覚', axisKey:'hearing', hyper:数値, hypo:数値}, ...]
  const rows = [];
  radar.forEach(d=>{
    // hyper（過敏）側
    if (TITLES.hyper[d.axisKey]) {
      rows.push({
        axisKey: d.axisKey,
        axis: d.axis,
        mode: 'hyper',
        title: TITLES.hyper[d.axisKey].t,
        role:  TITLES.hyper[d.axisKey].role,
        level: pctToLv(d.hyper),
        raw:   d.hyper
      });
    }
    // hypo（鈍麻）側
    if (TITLES.hypo[d.axisKey]) {
      rows.push({
        axisKey: d.axisKey,
        axis: d.axis,
        mode: 'hypo',
        title: TITLES.hypo[d.axisKey].t,
        role:  TITLES.hypo[d.axisKey].role,
        level: pctToLv(d.hypo),
        raw:   d.hypo
      });
    }
  });
  // レベル降順（同点は raw% で比較）
  return rows.sort((a,b)=> (b.level - a.level) || (b.raw - a.raw));
}

    
    function renderAxisFeedback(radar){
      const scored = radar.map(d=>({ key:d.axisKey, label:d.axis, hyper:d.hyper, hypo:d.hypo }));
      const picks = scored.filter(s=>Math.max(s.hyper,s.hypo)>=60)
                          .sort((a,b)=>Math.max(b.hyper,b.hypo)-Math.max(a.hyper,a.hypo));
      const list = (picks.length? picks: scored.sort((a,b)=>Math.max(b.hyper,b.hypo)-Math.max(a.hyper,a.hypo)).slice(0,3));
      return list.map(s=>{
        const mode = s.hyper> s.hypo ? 'hyper' : (s.hypo> s.hyper? 'hypo':'mix');
        const book = COMMENT_BOOK[s.key];
        const strong = mode==='mix'? [...book.hyper.strong,...book.hypo.strong].slice(0,2) : book[mode].strong;
        const challenge = mode==='mix'? [...book.hyper.challenge,...book.hypo.challenge].slice(0,2) : book[mode].challenge;
        const tips = mode==='mix'? [...book.hyper.tips,...book.hypo.tips].slice(0,3) : book[mode].tips;
        return `
          <div class="card">
            <h3>${s.label}</h3>
            <div class="small muted">過敏:${s.hyper}% / 鈍麻:${s.hypo}%</div>
            <div class="cols" style="margin-top:8px">
              <div><div style="font-weight:600; margin-bottom:6px">得意なこと（強み）</div><ul>${strong.map(x=>`<li>${x}</li>`).join('')}</ul></div>
              <div><div style="font-weight:600; margin-bottom:6px">苦手になりやすいこと</div><ul>${challenge.map(x=>`<li>${x}</li>`).join('')}</ul></div>
              <div><div style="font-weight:600; margin-bottom:6px">対処法のヒント</div><ul>${tips.map(x=>`<li>${x}</li>`).join(' ')}</ul></div>
            </div>
          </div>`;
      }).join('');
    }

    const COMMENT_BOOK = {
      hearing: {
        hyper: { strong:['微かな音の変化に気づける観察力'], challenge:['人混みや大音量の場所で疲れやすい'], tips:['ノイズキャンセリング/耳栓の活用','静かな席や時間帯を選ぶ','通知音量の微調整'] },
        hypo:  { strong:['賑やかな環境でも集中しやすい'], challenge:['呼びかけやアナウンスを聞き逃しやすい'], tips:['バイブ/光での通知','視覚サインの併用','重要連絡は文字ベースで受け取る'] }
      },
      vision: {
        hyper: { strong:['細かな差異にすぐ気づける洞察力'], challenge:['強い光/ちらつきで疲れやすい'], tips:['遮光/偏光レンズ','画面の明るさ/配色を調整','紙面作業をこまめに挟む'] },
        hypo:  { strong:['暗所で落ち着いて動ける'], challenge:['細部の変化に気づきにくい'], tips:['コントラスト強調','要点のマーキング','タスク前のチェックリスト'] }
      },
      touch: {
        hyper: { strong:['素材/肌触りへの審美眼'], challenge:['タグ/チクチク/ベタつきがストレス'], tips:['肌当たりの良い素材選び','タグカット/裏返し着用','ウェットティッシュ常備'] },
        hypo:  { strong:['圧や重みで落ち着きやすい'], challenge:['小さなケガや汚れに気づきにくい'], tips:['定期的なボディチェック','加重ブランケットの活用','触覚入力のバランス'] }
      },
      smell: {
        hyper: { strong:['香りの違いを見分ける能力'], challenge:['香料が混ざる場所が苦手'], tips:['マスク/アロマでリセット','換気の良い席を確保','香り強い洗剤を避ける'] },
        hypo:  { strong:['強い匂いにも冷静'], challenge:['危険な臭いに気づきにくい'], tips:['期限表示の確認習慣','他者に確認を頼む','におい以外の衛生指標を使う'] }
      },
      taste: {
        hyper: { strong:['味の違いを楽しむ繊細さ'], challenge:['食べられる品目が限られやすい'], tips:['食感/香り単位での置き換え','調味/調理法の微調整','小さな一歩の試食'] },
        hypo:  { strong:['刺激的な味を楽しむ冒険心'], challenge:['塩分/辛味の過剰に注意'], tips:['栄養バランス表の活用','味以外（温度/見た目）の満足要素を増やす','医療的制限がある場合は専門家相談'] }
      },
      tempPain: {
        hyper: { strong:['体調変化の早期察知'], challenge:['気温/痛みの変化で消耗しやすい'], tips:['重ね着/冷温アイテム','作業時間を短ブロック化','こまめな休憩'] },
        hypo:  { strong:['幅広い環境に適応できる'], challenge:['熱中症/低体温に気づきにくい'], tips:['タイマーで水分/休憩を促す','活動ログで体調を可視化','危険温度の客観指標を使う'] }
      },
      movement: {
        hyper: { strong:['バランス変化に敏感'], challenge:['乗り物酔い/人混みがつらい'], tips:['混雑回避ルート','安定した姿勢/視点固定','乗り物は前方/風通し良い席'] },
        hypo:  { strong:['スリル/運動を楽しめる'], challenge:['危険察知が遅れがち'], tips:['安全ルールの事前確認','プロテクターの使用','段階的に刺激レベルを上げる'] }
      }
    };

    function renderLowOverallCard(){
      return `
        <div class="card">
          <h3>今回のまとめ</h3>
          <p class="muted">全体的に大きな偏りは見られませんでした。日によって「少し気になる」「今日は平気」など、ゆるやかな変化があるタイプかもしれません。</p>
          <ul>
            <li>困りごとが少ない時は、そのままの環境でOK</li>
            <li>疲れている日は、音や光など一つだけでもコントロールできると楽に</li>
            <li>「しんどさログ」をつけると自分の傾向が見つけやすい</li>
          </ul>
        </div>`;
    }

// ===== ヘルパー（この2つをファイル内どこかに追加。重複があれば置き換え）=====
function measureWrap(ctx, text, maxWidth){
  const words = [...text]; // 全角対応の1文字ずつ
  const lines = [];
  let line = '';
  for(const ch of words){
    const test = line + ch;
    if(ctx.measureText(test).width > maxWidth && line){
      lines.push(line);
      line = ch;
    }else{
      line = test;
    }
  }
  if(line) lines.push(line);
  return lines;
}
function drawWrap(ctx, text, x, y, maxWidth, lineHeight){
  const lines = measureWrap(ctx, text, maxWidth);
  for(const ln of lines){ ctx.fillText(ln, x, y); y += lineHeight; }
  return y;
}
    
function getCatchCopy(title){
  const map = {
    'エルフ耳の斥候（スカウト）': '微かな変化も見逃さない、静寂の守護者！',
    '洞察の魔法使い（メイジ）': '光と影を読み解く、千里眼の術師！',
    '結界の守護者（ガーディアン）': '触覚の盾で仲間を守る、堅牢の守護者！',
    '毒の鑑定士（アルケミスト）': '香りで真実を見抜く、鼻利きの賢者！',
    '美食の王子／姫（グルメ）': '一口で世界がひらく、味覚の探究者！',
    '気候予報士（メイジ）': '温度と痛みのサインを読む、環境の賢者！',
    '揺れセンサー搭載者（ナイト）': 'わずかな揺れも察知する、均衡の騎士！',

    '戦場の鼓手（バード）': 'リズムで仲間を導く、戦場の指揮官！',
    '月影のハンター（ハンター）': '薄闇を味方にする、静謐の狩人！',
    '鉄皮のモンク（モンク）': '衝撃を受け止める、泰然の拳！',
    '炉心の鍛冶師（ブラックスミス）': '匂いの渦でもぶれない、集中の職人！',
    '香辛の冒険家（エクスプローラー）': '刺激を楽しむ、味覚の冒険者！',
    '四季渡りのノマド（ノマド）': '気候にしなやかに馴染む、タフネス旅人！',
    '竜騎のランサー（ドラグーン）': 'スピードと回転を制す、空駆ける槍！',

    '感覚の双剣士（デュアルブレード）': '反応を切り替える、二刀流の戦術家！',
    'バランス型：ノーマライザー': 'どんな環境でも整える、調律の名手！'
  };
  // 該当なし時のやさしい汎用文
  return map[title] || '自分の感覚を味方につける、冒険の始まり！';
}

function drawRoundedRect(ctx, x, y, w, h, r, fillStyle) {
  const rr = Math.min(r, h/2, w/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y,   x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x,   y+h, rr);
  ctx.arcTo(x,   y+h, x,   y,   rr);
  ctx.arcTo(x,   y,   x+w, y,   rr);
  ctx.closePath();
  const prev = ctx.fillStyle;
  ctx.fillStyle = fillStyle;
  ctx.fill();
  ctx.fillStyle = prev;
}

function fitTextSize(ctx, text, maxWidth, base=32, min=18, step=2, fontFamily='system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial'){
  for(let size=base; size>=min; size-=step){
    ctx.font = `700 ${size}px ${fontFamily}`;
    if (ctx.measureText(text).width <= maxWidth) return size;
  }
  // どうしても入らない場合は最小サイズで
  ctx.font = `700 ${min}px ${fontFamily}`;
  return min;
}

    
// ===== ここを差し替え =====
async function saveResultPng({ title, level, roleImgSrc, chartCanvasId = 'radar', top3 = [], pageUrl = '', hashtags = '' }){
  try{
    const roleImg = await loadImage(roleImgSrc);
    const chart = document.getElementById(chartCanvasId);
    if (!chart) { alert('チャートが見つかりませんでした'); return; }

    // レイアウト基準
    const W = 1080;               // 出力幅
    const P = 48;                 // 外側パディング
    const GAP = 28;               // ブロック間の基本余白
    const COL = W - P*2;          // コンテナ幅

    // フォント（先に計測用に設定）
    const tmp = document.createElement('canvas').getContext('2d');
    tmp.font = 'bold 48px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    const titleLines = measureWrap(tmp, 'KANKAKUクエスト 診断結果', COL);

    tmp.font = 'bold 40px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    const titleLine2 = measureWrap(tmp, `称号：${title}`, COL);

    tmp.font = '600 36px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    const titleLine3 = measureWrap(tmp, `レベル：Lv${String(level).padStart(2,'0')}`, COL);

    // 画像サイズを自動スケール
    const roleW = Math.min(COL, 560);
    const roleH = Math.round(roleW * (roleImg.height / roleImg.width));

    // レーダーはアスペクト固定で縮小（チャート実サイズを取得して比率で）
    const chartAspect = chart.height > 0 ? (chart.width / chart.height) : (4/3);
    const chartW = Math.min(COL, 720);
    const chartH = Math.round(chartW / chartAspect);

    // 備考テキストの行数見積り
    tmp.font = '24px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    const disclaimer = '※ この結果は自己回答に基づく簡易チェックです。医学的な診断を提供するものではありません。';
    const discLines = measureWrap(tmp, disclaimer, COL);

     // TOP3（小サムネ行）高さ見積り
 const hasTop3 = Array.isArray(top3) && top3.length > 0;
 const thumbW = 140, thumbH = 140; // 画像を縮小表示
 const top3RowH = hasTop3 ? (thumbH + 68) : 0; // 画像＋キャプション分のだいたい

 // フッタ（URL / ハッシュタグ / バージョン）
 const FOOTER_H = 56;
    

    // キャンバス高さを計算（行高はおおむねフォントサイズ+余白）
    const hTitle1 = titleLines.length * 56;
    const hTitle2 = titleLine2.length * 50;
    const hTitle3 = titleLine3.length * 44;
    const hDisc   = discLines.length * 34;

 const H = P + hTitle1 + GAP/2 + hTitle2 + GAP/3 + hTitle3 + GAP +
           roleH + GAP + (hasTop3 ? (top3RowH + GAP) : 0) +
           chartH + GAP + hDisc + GAP + FOOTER_H + P;

    // 本番キャンバス
    const out = document.createElement('canvas');
    out.width = W;
    out.height = H;
    const g = out.getContext('2d');

    // 背景
    g.fillStyle = '#ffffff';
    g.fillRect(0,0,out.width,out.height);

    let y = P;

// 見出し
g.fillStyle = '#0f172a';
g.font = 'bold 48px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
g.textAlign = 'center';
g.fillText('KANKAKUクエスト 診断結果', W/2, y);
y += 56 + (GAP/4);

// 称号
g.font = 'bold 40px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
g.fillText(`称号：${title}`, W/2, y);
y += 50;

// レベル
g.font = '600 36px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
g.fillText(`レベル：Lv${String(level).padStart(2,'0')}`, W/2, y);
y += GAP;

g.textAlign = 'left';

    // === ここから追加：キャッチコピー（中央寄せの角丸バッジ） ===
const catchCopy = getCatchCopy(title);
const PADX = 16, PADY = 10;
const MAX_W = Math.min(760, (W - P*2));     // 左右マージンを確保
// 可変フォントサイズで幅に収める
const size = fitTextSize(g, catchCopy, MAX_W - PADX*2, 32, 18);
const textW = g.measureText(catchCopy).width;
const pillW = Math.min(textW + PADX*2, MAX_W);
const pillH = Math.round(size + PADY*2);
const pillX = Math.round((W - pillW)/2);
const pillY = y;

drawRoundedRect(g, pillX, pillY, pillW, pillH, 12, 'rgba(15,23,42,0.85)'); // ほぼ黒・半透明
const prevAlign = g.textAlign, prevBase = g.textBaseline, prevFill = g.fillStyle;
g.fillStyle = '#ffffff';
g.textAlign = 'center';
g.textBaseline = 'middle';
g.fillText(catchCopy, pillX + pillW/2, pillY + pillH/2);
g.textAlign = prevAlign; 
g.textBaseline = prevBase; 
g.fillStyle = prevFill;

y += pillH + 24; // 次の要素との間隔
// === 追加ここまで ===

// 役職イラスト（中央寄せ）
g.drawImage(roleImg, P + (COL - roleW) / 2, y, roleW, roleH);
y += roleH + GAP;

    

// チャート（中央寄せ）
await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
g.drawImage(chart, P + (COL - chartW) / 2, y, chartW, chartH);
y += chartH + GAP;

 // === TOP3（小カード3つ） ===
 if (hasTop3){
   // 画像を先に読み込み
   const imgs = await Promise.all(top3.map(j => j.img ? loadImage(j.img) : Promise.resolve(null)));
   const colGap = 18;
   const totalW = thumbW*3 + colGap*2;
   let x = Math.round((W - totalW)/2);
   // タイトル行
   g.fillStyle = '#0f172a';
   g.font = '700 28px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
   g.textAlign = 'center';
   g.fillText('上位ジョブ TOP3', W/2, y+28);
   g.textAlign = 'left';
   y += 36;
   // 各カード
   for(let i=0;i<top3.length;i++){
     const j = top3[i];
     const img = imgs[i];
     // カード枠
    const cardW = thumbW, cardH = thumbH + 60;
     drawRoundedRect(g, x, y, cardW, cardH, 12, i===0 ? '#fffbeb' : i===1 ? '#f1f5f9' : '#faf5ff');
     g.strokeStyle = i===0 ? '#f59e0b' : i===1 ? '#94a3b8' : '#c084fc';
     g.lineWidth = 1;
     g.strokeRect(x+0.5, y+0.5, cardW-1, cardH-1);
     // 画像
     if (img){
       const ratio = Math.min(thumbW / img.width, thumbH / img.height);
       const iw = Math.round(img.width * ratio);
       const ih = Math.round(img.height * ratio);
       const ix = x + Math.round((thumbW - iw)/2);
       const iy = y + 8 + Math.round((thumbH - ih)/2);
       g.drawImage(img, ix, iy, iw, ih);
     }
     // キャプション
     g.fillStyle = '#0f172a';
     g.font = '700 16px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
     g.textAlign = 'center';
     g.fillText(j.role, x + thumbW/2, y + thumbH + 24);
     g.font = '600 14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
     g.fillText(`Lv${String(j.level).padStart(2,'0')}・${j.axisLabel}・${j.mode==='hyper'?'過敏':'鈍麻'}`, x + thumbW/2, y + thumbH + 44);
     g.textAlign = 'left';
     x += thumbW + colGap;
   }
   y += top3RowH + GAP;
 }
// 免責
g.fillStyle = '#64748b';
g.font = '24px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
drawWrap(g, disclaimer, P, y, COL, 34);
y += GAP;

// フッタ（左：URL、中：ハッシュタグ、右：バージョン）
g.font = '16px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
g.fillStyle = '#475569';

// 左
if (pageUrl){
  g.textAlign = 'left';
  g.fillText(pageUrl, P, y + 22);
}
// 中
if (hashtags){
  g.textAlign = 'center';
  g.fillText(hashtags, W/2, y + 22);
}
// 右（APP_VERSION は別スクリプトで定義済み）
const versionText = (typeof APP_VERSION!=='undefined') ? `v${APP_VERSION}` : '';
if (versionText){
  g.textAlign = 'right';
  g.fillText(versionText, W - P, y + 22);
}
g.textAlign = 'left';


    // ダウンロード or 共有
    const dataUrl = out.toDataURL('image/png');
    try{
      const file = await dataUrlToFile(dataUrl, 'kankaku-result.png');
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: 'KANKAKUクエスト結果' });
        return;
      }
    }catch(_){}

    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = 'kankaku-result.png';
    document.body.appendChild(a);
    a.click();
    a.remove();

  }catch(e){
    console.error(e);
    alert('画像の保存に失敗しました。ページを再読み込みして再試行してください。');
  }
}
    
    function loadImage(src) {
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = rej;
        img.src = src;
      });
    }
    async function dataUrlToFile(dataUrl, filename){
      const res = await fetch(dataUrl);
      const blob = await res.blob();
      return new File([blob], filename, { type: 'image/png' });
    }

    /* ===== スティッキー告知バー ===== */
    function showSticky(url){
      const el = document.getElementById('stickyCta');
      const btn = document.getElementById('stickyBtn');
      const left = document.getElementById('leftDays');
      if (!el || !btn || !left) return;

      btn.href = url;

      const today = new Date();
      const eventDate = new Date(SEMINAR_DATE + 'T00:00:00');
      const diff = Math.max(0, Math.ceil((eventDate - today)/(1000*60*60*24)));
      left.textContent = diff;

      const muteUntil = +localStorage.getItem('sticky_mute_until') || 0;
      if (Date.now() < muteUntil) { el.hidden = true; return; }

      el.hidden = false;
      document.getElementById('stickyClose').onclick = ()=>{
        el.hidden = true;
        localStorage.setItem('sticky_mute_until', String(Date.now() + 24*60*60*1000));
      };
    }
    function hideSticky(){ const el = document.getElementById('stickyCta'); if(el) el.hidden = true; }

    /* ===== ユーティリティ ===== */

// 各軸から「どっち側のジョブが強いか」を1つ選ぶ
function chooseJobForAxis(d){
  const mode = (d.hyper >= d.hypo) ? 'hyper' : 'hypo';
  const score = (mode==='hyper') ? d.hyper : d.hypo;
  const key = d.axisKey;
  const titleObj = TITLES[mode][key];
  const img = (mode==='hyper') ? IMAGES.rolesHyper[key] : IMAGES.rolesHypo[key];
  const axisLabel = d.axis;
  const level = pctToLv(score);
  return { axisKey:key, axisLabel, mode, score, level, title:titleObj.t, role:titleObj.role, img };
}

// TOP3カードを描画
function renderTopJobs(radar){
  const jobs = radar.map(chooseJobForAxis).sort((a,b)=> b.score - a.score);
  const top3 = jobs.slice(0,3);
  return `
    <div class="card">
      <h3>上位ジョブ TOP3</h3>
      <div class="top-jobs">
        ${top3.map((j,i)=>`
          <div class="job-card rank-${i+1}">
            <div class="small muted">${j.axisLabel}／${j.mode==='hyper'?'過敏':'鈍麻'}</div>
            ${j.img ? `<img src="${j.img}" alt="${j.title}">` : ``}
            <div class="title">${j.title}</div>
            <div class="lv">Lv${String(j.level).padStart(2,'0')}</div>
          </div>
        `).join('')}
      </div>
    </div>`;
}

    
    function preload(srcs=[]){ srcs.forEach(s => { const i = new Image(); i.src = s; }); }

    window.addEventListener('DOMContentLoaded', () => {
      const roleImgs = [
        IMAGES.balanced, IMAGES.dual, IMAGES.title,
        ...Object.values(IMAGES.rolesHyper),
        ...Object.values(IMAGES.rolesHypo)
      ].filter(Boolean);
      preload(roleImgs);
      renderStart();
    });
  </script>

<!-- バージョン表示用 -->
<div id="version-info" style="position:absolute; top:10px; right:10px; font-size:12px; color:#555;">
  Ver.1.2（読み込み中...）
</div>

<script>
  // バージョン番号（手動で更新）
  const APP_VERSION = "1.243";

  // ページ読み込み時に現在の日時を取得して表示
  window.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('version-info').textContent =
      `Ver.${APP_VERSION}（${y}-${m}-${d} ${hh}:${mm}）`;
  });
</script>


  
</body>
</html>
