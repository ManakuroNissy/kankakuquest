<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <title>KANKAKUクエスト — あなたの感覚ジョブ診断</title>

    <!-- ===== 静的OGP ===== -->
    <meta property="og:title" content="KANKAKUクエスト — あなたの感覚ジョブ診断">
    <meta property="og:description" content="7つの感覚（聴覚/視覚/触覚/嗅覚/味覚/温度・痛み/動き）を簡易チェック。称号とレーダーチャートを表示。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://manakuronissy.github.io/">
    <meta property="og:image" content="https://manakuronissy.github.io/og/og-default.png">
    <meta property="og:site_name" content="KANKAKUクエスト">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="KANKAKUクエスト — あなたの感覚ジョブ診断">
    <meta name="twitter:description" content="称号とレーダーチャートで感覚の傾向を見える化。">
    <meta name="twitter:image" content="https://manakuronissy.github.io/og/og-default.png">

    <!-- Chart.js（レーダーチャート用） -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
      :root{
        --bg:#f7f8fb; --card:#fff; --ink:#0f172a; --muted:#616b7c; --brand:#2563eb; --brand2:#0f172a;
        --ring:#e5e7eb; --good:#16a34a; --warn:#ea580c;
      }
      *{box-sizing:border-box}
      html{-webkit-text-size-adjust:100%;text-size-adjust:100%;max-width:100%;overflow-x:hidden;}
      body{margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--ink); background:linear-gradient(#f7f8fb,#fff);max-width:100%;overflow-x:hidden;}

      /* === モバイル横はみ出し対策（共通） === */
      img,svg,canvas,video{max-width:100%;height:auto;display:block}
      .seminar-banner{width:100%;height:auto;display:block}

      .container{max-width:960px; margin:0 auto; padding:16px}
      header{position:sticky; top:0; background:#ffffffbb; backdrop-filter:saturate(1.1) blur(6px); border-bottom:1px solid var(--ring)}
      header .bar{display:flex; align-items:center; justify-content:space-between; padding:10px 16px}
      .brand{display:flex; gap:10px; align-items:center; cursor:pointer; text-decoration:none; color:inherit}
      .brand .logo{width:32px;height:32px;border-radius:10px;background:var(--brand2);color:#fff;display:grid;place-items:center;font-weight:700}
      .button{border:1px solid var(--ring); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer}
      .button.primary{background:var(--brand); color:#fff; border-color:transparent}
      .button[disabled]{opacity:.5; cursor:not-allowed}
      /* ブランドカラーのシェアボタン */
      .button.x  { background:#000;   color:#fff; border-color:#000 }
      .button.fb { background:#1877F2; color:#fff; border-color:#1877F2 }
      .button.x:hover,.button.fb:hover{filter:brightness(.95)}
      .grid{display:grid; gap:16px}
      .card{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:18px}
      .hero img{width:70%; max-width:800px; margin:0 auto; display:block}
      .progress{height:8px; background:#e5e7eb; border-radius:99px; overflow:hidden}
      .progress > div{height:100%; background:var(--brand2)}
      .likert{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:16px}
      .likert button{padding:10px 14px; border:1px solid var(--ring); border-radius:12px; transition:filter .15s ease}
      .likert button.active{outline:2px solid #facc15; border-color:#facc15}
      /* 回答ボタンの色分け（v0〜v4） */
      .likert .v0{ background:#e6f7ec; }
      .likert .v0:hover{ filter:brightness(.98); }
      .likert .v1{ background:#fff8db; }
      .likert .v1:hover{ filter:brightness(.98); }
      .likert .v2{ background:#ffefaf; }
      .likert .v2:hover{ filter:brightness(.98); }
      .likert .v3{ background:#fde68a; }
      .likert .v3:hover{ filter:brightness(.97); }
      .likert .v4{ background:#facc15; }
      .likert .v4:hover{ filter:brightness(.97); }

      .cols{display:grid; gap:16px}
      @media(min-width:900px){.cols{grid-template-columns:repeat(3,1fr)}}
      .small{font-size:12px; color:#475569}
      .muted{color:#616b7c}
      .badge{display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background:#eef2ff}
      .center{text-align:center}
      img.role{width:360px; height:auto; display:block; margin:8px auto 0; max-width:100%;}
      .level-display{font-size:20px; font-weight:700; margin-top:6px}
      .role-comment{margin-top:6px; color:#374151}
      footer{color:#6b7280; font-size:12px; padding:24px 16px}
      .cta{background:#eff6ff; border:1px solid #bfdbfe}
      .start-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; margin-top:12px}
      .share{display:grid; gap:10px; justify-items:center}
      .share .buttons{display:flex; flex-wrap:wrap; gap:8px; justify-content:center}
      .level-grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
      @media(min-width:700px){.level-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
      .level-item{border:1px solid var(--ring); border-radius:12px; padding:10px; background:#fff}
      .level-item .lv{font-weight:700}
      .chip{display:inline-block; padding:2px 8px; font-size:12px; border-radius:999px; background:#f1f5f9; margin-left:6px}
      .disclaimer{margin-top:10px; font-size:12px; color:#64748b; line-height:1.6}
      #homeLink{pointer-events:none; cursor:default}
      .radar-wrap{height:360px; margin:14px auto 0; display:flex; align-items:center; justify-content:center; max-width:560px; width:100%;}
      @media(max-width:480px){
        .container{padding:12px}
        header .bar{padding:8px 12px}
        .hero img{width:100%; max-width:none}
        h1,h2{font-size:20px}
        .card{padding:14px}
        img.role{width:68vw; max-width:280px}
        .level-display{font-size:16px}
        .role-comment{font-size:14px; line-height:1.6}
        .level-grid{grid-template-columns:1fr}
        .share .buttons .button{width:100%}
        .radar-wrap{height:300px; max-width:100%;}
      }
    </style>
  </head>
  <body>
    <header>
      <div class="bar container">
        <a id="homeLink" class="brand" aria-label="KANKAKUクエスト">
          <div class="logo">Q</div><div style="font-weight:700">KANKAKUクエスト</div>
        </a>
        <a id="seminarBtnTop" class="button primary" target="_blank" href="#">8/23 セミナーを見る</a>
      </div>
    </header>

    <main id="app" class="container"></main>

    <footer class="container">
      <div style="margin-bottom:6px;">by <strong>MANAKURO</strong></div>
      プライバシー：回答は端末内で処理され、同意なく保存されません。
    </footer>

    <script>
      /* ================= 設定 ================= */
      const SEMINAR_DATE = '2025-08-23';
      const SEMINAR_URL  = 'https://forms.gle/hWcV6LZDvR2S9wX88';
      const QUESTION_COUNT = 28; // 各軸：過敏2＋鈍麻2（固定28問）
      const DUAL_THRESHOLD = 70; // 両極端（dual）判定のしきい値（%）

      // 画像パス（あなたの /images に一致）
      const IMAGES = {
        title: 'images/title-image.png',
        rolesHyper: {
          hearing:   'images/job-elf-scout.png',
          vision:    'images/job-wizard.png',
          touch:     'images/job-guardian.png',
          smell:     'images/job-poison-appraiser.png',
          taste:     'images/job-gourmet.png',
          tempPain:  'images/job-weather-mage.png',
          movement:  'images/job-knight.png'
        },
        rolesHypo: {
          hearing:   'images/job-hearing-hypo.png',
          vision:    'images/job-vision-hypo.png',
          touch:     'images/job-touch-hypo.png',
          smell:     'images/job-smell-hypo.png',
          taste:     'images/job-taste-hypo.png',
          tempPain:  'images/job-tempPain-hypo.png',
          movement:  'images/job-movement-hypo.png'
        },
        balanced: 'images/job-nomal.png',  // バランス型（ファイル名は "nomal" でOK）
        dual:     'images/job-dualblade.png'
      };

      const TITLES = {
        hyper: {
          hearing:  { t: 'エルフ耳の斥候（スカウト）', role: 'スカウト' },
          vision:   { t: '洞察の魔法使い（メイジ）', role: 'メイジ' },
          touch:    { t: '結界の守護者（ガーディアン）', role: 'ガーディアン' },
          smell:    { t: '毒の鑑定士（アルケミスト）', role: 'アルケミスト' },
          taste:    { t: '美食の王子／姫（グルメ）', role: 'グルメ' },
          tempPain: { t: '気候予報士（メイジ）', role: 'メイジ' },
          movement: { t: '揺れセンサー搭載者（ナイト）', role: 'ナイト' },
        },
        hypo: {
          hearing:  { t: '戦場の鼓手（バード）', role: 'バード' },
          vision:   { t: '月影のハンター（ハンター）', role: 'ハンター' },
          touch:    { t: '鉄皮のモンク（モンク）', role: 'モンク' },
          smell:    { t: '炉心の鍛冶師（ブラックスミス）', role: 'ブラックスミス' },
          taste:    { t: '香辛の冒険家（エクスプローラー）', role: 'エクスプローラー' },
          tempPain: { t: '四季渡りのノマド（ノマド）', role: 'ノマド' },
          movement: { t: '竜騎のランサー（ドラグーン）', role: 'ドラグーン' },
        },
        dual: { any: { t: '感覚の双剣士（デュアルブレード）', role: 'デュアルブレード' } },
        normal: { any: { t: 'バランス型：ノーマライザー', role: 'ノーマライザー' } }
      };

      /* ▼▼ SNS用：役職コメント（50字内トリム用に使用） ▼▼ */
      const ROLE_COMMENTS = {
        hyper: {
          hearing:  '小さな音も聞き逃さない探索の達人。静寂の守護者。',
          vision:   '光や動きの変化を見抜く鋭視のメイジ。隠し扉もお手の物。',
          touch:    '風や布の質感まで察知する触覚の盾。心地よい装備選びの達人。',
          smell:    '香りで世界を読み解く鑑定士。危険信号も素早くキャッチ。',
          taste:    '味の物語を読み解く舌。料理は芸術、素材の個性は正直に。',
          tempPain: '温度や痛みの変化を即察知。環境センサーで仲間を守る。',
          movement: 'わずかな揺れも見逃さない守護騎士。空と海の旅は慎重派。'
        },
        hypo: {
          hearing:  '雑踏でも落ち着いて動ける耳のタフネス。嵐でも冷静。',
          vision:   '薄暗い道も慌てない夜の狩人。洞窟探索は任せて。',
          touch:    '衝撃にも動じない武闘僧。険しい道も踏破する持久力。',
          smell:    '香りの渦中でも集中を切らさない職人肌。作業に没頭できる。',
          taste:    '未知の料理に果敢に挑む冒険胃袋。刺激も楽しめる。',
          tempPain: '気候変化にタフなノマド。暑さ寒さに振り回されにくい。',
          movement: '回転や加速も面白がる空の戦士。スピードの相棒。'
        },
        dual: '二つの感覚の刃を携え、あらゆる刺激に挑む戦術家。',
        balanced: 'どんな環境でもマイペース。感覚の調律に長けたバランス職人。'
      };

      const AXES = [
        { key: 'hearing',  label: '聴覚' },
        { key: 'vision',   label: '視覚' },
        { key: 'touch',    label: '触覚' },
        { key: 'smell',    label: '嗅覚' },
        { key: 'taste',    label: '味覚' },
        { key: 'tempPain', label: '温度/痛み' },
        { key: 'movement', label: '動き' },
      ];

      /* ================ 質問（最終版 28問） ================ */
      const BANK = [
        // ── 聴覚 ──
        { id:'h_h_1', axis:'hearing', trait:'hyper', adult:'店内やオフィスのざわめきで集中が途切れやすい' },
        { id:'h_h_2', axis:'hearing', trait:'hyper', adult:'突然の大きな音が苦手で、体が強く反応してしまう' },
        { id:'h_y_1', axis:'hearing', trait:'hypo',  adult:'雑音の中で呼ばれても気づきにくい' },
        { id:'h_y_2', axis:'hearing', trait:'hypo',  adult:'にぎやかな場所で小さな音に気づくのが遅れがち' },

        // ── 視覚 ──
        { id:'v_h_1', axis:'vision', trait:'hyper', adult:'強い照明や画面の光がつらく、遮光したくなる' },
        { id:'v_h_2', axis:'vision', trait:'hyper', adult:'画面のちらつきや速い動きに疲れやすい' },
        { id:'v_y_1', axis:'vision', trait:'hypo',  adult:'部屋が暗くなったことに気が付きにくい' },
        { id:'v_y_2', axis:'vision', trait:'hypo',  adult:'画面や印刷の細かい違いに気づきにくい' },

        // ── 触覚 ──
        { id:'t_h_1', axis:'touch', trait:'hyper', adult:'チクチクする服やタグが苦手' },
        { id:'t_h_2', axis:'touch', trait:'hyper', adult:'手や服のベタつきが気になる' },
        { id:'t_y_1', axis:'touch', trait:'hypo',  adult:'ぎゅっとした圧があると落ち着く' },
        { id:'t_y_2', axis:'touch', trait:'hypo',  adult:'軽い擦り傷にすぐ気づきにくい' },

        // ── 嗅覚 ──
        { id:'s_h_1', axis:'smell', trait:'hyper', adult:'香水や柔軟剤のにおいが強く感じられて離れたくなる' },
        { id:'s_h_2', axis:'smell', trait:'hyper', adult:'料理のにおいが混ざる場所が苦手' },
        { id:'s_y_1', axis:'smell', trait:'hypo',  adult:'香りの強弱の差を感じ取りにくい' },
        { id:'s_y_2', axis:'smell', trait:'hypo',  adult:'食品の傷みのにおいに気づくのが遅れがち' },

        // ── 味覚 ──
        { id:'ta_h_1', axis:'taste', trait:'hyper', adult:'繊細な味の違いがわかり、好みがはっきりしている' },
        { id:'ta_h_2', axis:'taste', trait:'hyper', adult:'食感や香りが合わないと食べづらい' },
        { id:'ta_y_1', axis:'taste', trait:'hypo',  adult:'濃い味やスパイスの強い料理を求める' },
        { id:'ta_y_2', axis:'taste', trait:'hypo',  adult:'新しい味の刺激を強く求める' },

        // ── 温度/痛み ──
        { id:'tp_h_1', axis:'tempPain', trait:'hyper', adult:'室温のわずかな変化が気になる' },
        { id:'tp_h_2', axis:'tempPain', trait:'hyper', adult:'小さな痛みでも集中が切れやすい' },
        { id:'tp_y_1', axis:'tempPain', trait:'hypo',  adult:'暑さ寒さに気づくのが遅れがち' },
        { id:'tp_y_2', axis:'tempPain', trait:'hypo',  adult:'軽いケガでも痛みをあまり感じない' },

        // ── 動き ──
        { id:'m_h_1', axis:'movement', trait:'hyper', adult:'人混みや揺れで酔いやすい' },
        { id:'m_h_2', axis:'movement', trait:'hyper', adult:'急な動きや加速が苦手' },
        { id:'m_y_1', axis:'movement', trait:'hypo',  adult:'スピードや回転の刺激を強く好む' },
        { id:'m_y_2', axis:'movement', trait:'hypo',  adult:'刺激を求めて走ったりジャンプしたくなる' }
      ];

      /* === 140字向けショート要約（従来） === */
      const SHORT_SUMMARY = {
        hearing:  { hyper:'小さな音を拾いやすい／大きな音がつらい', hypo:'にぎやかでも集中しやすい／呼びかけを見落としがち' },
        vision:   { hyper:'細部に気づく／強い光やちらつきが苦手',       hypo:'暗所に強い／細かな変化は見落としやすい' },
        touch:    { hyper:'素材感に敏感／チクチクやベタつきが苦手',       hypo:'圧刺激で落ち着く／小さなケガに気づきにくい' },
        smell:    { hyper:'香りの差に鋭い／混ざったにおいが苦手',         hypo:'強いにおいも平気／危険なにおいに気づきにくい' },
        taste:    { hyper:'味の違いに敏感／食べられる幅が狭くなりがち',   hypo:'刺激的な味が得意／塩分や辛味が多くなりがち' },
        tempPain: { hyper:'変化を早く察知／気温や痛みで消耗しやすい',     hypo:'環境にタフ／暑さ寒さに気づくのが遅れがち' },
        movement: { hyper:'揺れに敏感／人混みや乗り物酔いが出やすい',     hypo:'スピードに強い／安全確認が遅れがち' },
        balanced: '偏りは少なめ。感じ方は状況次第。'
      };

      function getShortSummary(overall, dominant){
        if (overall==='balanced') return SHORT_SUMMARY.balanced;
        if (overall==='dual') return '過敏と鈍麻の両方が高め：使い分けが鍵。';
        return SHORT_SUMMARY[dominant][overall];
      }

      function baseURL(){
        return location.origin + location.pathname.replace(/index\.html$/,'');
      }

      // 傾向の見出し（ライト表現）
      function tendencyLabel(overall, dominant){
        if (overall==='balanced') return 'バランス型の傾向かも？';
        if (overall==='dual')     return '過敏と鈍麻、両方が高い“両極端”タイプかも？';
        const axis = AXES.find(a=>a.key===dominant)?.label || '';
        return `${axis}${overall==='hyper'?'過敏':'鈍麻'}の傾向かも？`;
      }

      // SNSコメント（役職コメントを短く整える：全角50字程度にトリム）
      function shortRoleComment(overall, dominant){
        if (overall==='balanced') return ROLE_COMMENTS.balanced;
        if (overall==='dual')     return ROLE_COMMENTS.dual;
        const raw = ROLE_COMMENTS[overall][dominant] || '';
        const limit = 50;
        return raw.length <= limit ? raw : (raw.slice(0, limit-1) + '…');
      }

      /* === 改行・空行入り：140字に極力収めるX用投稿文 === */
      function buildShortShareText({title, level, overall, dominant}){
        const url = baseURL();
        const urlLen = 23; // XのURL換算長
        const nl = '\n';
        const lines = [
          '【感覚クエスト⚔️診断結果】',
          '',
          `称号「${title}」 Lv${String(level).padStart(2,'0')}`,
          tendencyLabel(overall, dominant),
          shortRoleComment(overall, dominant),
          '',
          'やってみる▶ ' + url,
          '',
          '#KANKAKUクエスト'
        ];
        let text = lines.join(nl);

        // 140字に収める（URL23文字扱い）
        const effLen = t => t.length - (url.length - urlLen);
        const limit = 140;
        if (effLen(text) <= limit) return text;
        const mini4 = shortRoleComment(overall, dominant).split('。')[0] + '。';
        const lines2 = [...lines];
        lines2[4] = mini4;
        text = lines2.join(nl);
        if (effLen(text) <= limit) return text;
        const lines3 = lines2.filter((l,i)=>!(i===1));
        text = lines3.join(nl);
        if (effLen(text) <= limit) return text;
        const lines4 = lines3.filter((l,i)=> i!==3);
        text = lines4.join(nl);
        return text;
      }

      /* === 5段階（0〜4）：0は「該当しない」 === */
      const LIKERT_WEIGHT = {0:0.00, 1:0.08, 2:0.28, 3:0.65, 4:1.00};
      const LIKERT = [
        { v:0, label:'あてはまらない' },
        { v:1, label:'すこしあてはまる' },
        { v:2, label:'ときどきあてはまる' },
        { v:3, label:'よくあてはまる' },
        { v:4, label:'とてもあてはまる' },
      ];

      /* ================ 状態 ================ */
      let qs = []; let answers = {}; let index = 0;
      const app = document.getElementById('app');

      /* ================ 画面 ================ */
      function renderStart(){
        app.innerHTML = `
          <div class="grid">
            <div class="card hero"><img src="${IMAGES.title}" alt="KANKAKUクエスト タイトル"></div>
            <div class="card" style="text-align:center">
              <h1>あなたの感覚ジョブ診断</h1>
              <p class="muted">
                簡単な質問に答えるだけで、聴覚・視覚・触覚・嗅覚・味覚・温度/痛み・<strong>動き</strong>の感じ方を見える化。<br>
                最後にレーダーチャートとRPG風の称号が表示されます。
              </p>
              <div class="start-actions">
                <button class="button primary" id="startBtn">診断をスタート</button>
              </div>
            </div>
          </div>`;
        document.getElementById('startBtn').onclick=()=>{ startQuestions(); };
        window.scrollTo(0,0);
      }

      function startQuestions(){
        qs = pickQuestions(QUESTION_COUNT);
        answers = {}; index = 0;
        renderQuestion();
      }

      function renderQuestion(){
        const total = qs.length;
        const q = qs[index];
        const answered = answers[q.id];
        const progress = Math.round(Object.keys(answers).length/total*100);
        app.innerHTML = `
          <div class="grid">
            <div class="progress"><div style="width:${progress}%"></div></div>
            <div class="card" style="text-align:center">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px">
                <div><span class="badge">${AXES.find(a=>a.key===q.axis).label}</span></div>
                <div class="small">${index+1} / ${total}</div>
              </div>
              <div style="font-size:18px; margin-bottom:20px">${q.adult}</div>
              <div class="likert" id="likert" role="radiogroup"></div>
              <div style="display:flex; justify-content:space-between; margin-top:14px">
                <button class="button" id="prevBtn" ${index===0?'disabled':''}>もどる</button>
                <span></span>
              </div>
            </div>
          </div>`;
        const wrap = document.getElementById('likert');

        // アクセシビリティ対応：キーボードで選択
        LIKERT.forEach((o, idx)=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = o.label;
          btn.className='button v'+o.v;
          btn.setAttribute('role','radio');
          const isOn = answered===o.v;
          if(isOn) btn.classList.add('active');
          btn.setAttribute('aria-checked', isOn ? 'true' : 'false');
          btn.tabIndex = isOn || (answered==null && idx===0) ? 0 : -1;

          btn.onclick=()=> selectAndNext(o.v);
          btn.onkeydown = (e)=>{
            if (e.key === 'ArrowRight' || e.key === 'ArrowDown'){
              e.preventDefault();
              const next = btn.nextElementSibling || wrap.firstElementChild;
              next.focus();
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp'){
              e.preventDefault();
              const prev = btn.previousElementSibling || wrap.lastElementChild;
              prev.focus();
            } else if (e.key === ' ' || e.key === 'Enter'){
              e.preventDefault();
              selectAndNext(o.v);
            }
          };
          wrap.appendChild(btn);
        });

        document.getElementById('prevBtn').onclick=()=>{ if(index>0){ index--; renderQuestion(); } };
        window.scrollTo({top:0, behavior:'smooth'});
      }

      // 選択→即次へ
      function selectAndNext(value){
        const q = qs[index];
        answers[q.id] = value; // 0〜4
        const total = qs.length;
        if(index+1 < total){ index++; renderQuestion(); }
        else { renderResult(); }
      }

      /* ================ 結果 ================ */
      function renderResult(){
        const s = calcScores(qs, answers);
        const { radar, hyperAvg, hypoAvg, overall, dominant, maxAny, lvDominant, lvBalanced, maxHyper, maxHypo, lvDual } = s;

        let titleObj = null, axisLabel = null, roleImg = null, level = null, lvLabel = 'Lv';
        if (overall === 'balanced') {
          titleObj = { t:'バランス型：ノーマライザー', role:'ノーマライザー' };
          axisLabel = 'バランス型';
          roleImg = IMAGES.balanced;
          level = lvBalanced;
          lvLabel = 'Lv（バランス度）';
        } else if (overall === 'dual') {
          titleObj = TITLES.dual.any;
          axisLabel = '両極端';
          roleImg = IMAGES.dual;
          level = lvDual;
        } else {
          const axis = AXES.find(a=>a.key===dominant);
          axisLabel = axis ? axis.label : '';
          titleObj = TITLES[overall][dominant];
          roleImg = overall==='hyper' ? IMAGES.rolesHyper[dominant] : IMAGES.rolesHypo[dominant];
          level = lvDominant;
        }

        let headNote = '';
        const diffAbs = Math.abs(hyperAvg - hypoAvg);
        const adjective = diffAbs >= 31 ? '非常に高め' : (diffAbs >= 16 ? '高め' : 'やや高め');
        if (overall === 'balanced' && maxAny <= 25) {
          headNote = '今回は大きな偏りは見つかりませんでした。状況や体調によって感じ方がゆるやかに変わる、柔軟タイプかもしれません。';
        } else if (overall === 'balanced') {
          headNote = `大きな偏りはありませんでした。比較的「${AXES.find(a=>a.key===dominant)?.label ?? '—'}」が気になりやすいかもしれません。`;
        } else if (overall === 'dual') {
          headNote = '過敏と鈍麻の両方が高く出ました。場面に応じて反応が切り替わるタイプかもしれません。使い分けの工夫が鍵です。';
        } else {
          headNote = `いちばん強く特徴が出たのは「${axisLabel}」。全体としては<strong>${overall==='hyper'?'過敏':'鈍麻'}</strong>の傾向が${adjective}でした。`;
        }

        const roleComment =
          overall==='balanced' ? ROLE_COMMENTS.balanced :
          overall==='dual'     ? ROLE_COMMENTS.dual :
          ROLE_COMMENTS[overall][dominant];

        app.innerHTML = `
          <div class="grid">
            <div class="card center">
              <h2>感覚クエスト⚔️診断結果</h2>
              <div class="muted">${headNote}</div>
              ${roleImg ? `<img class="role" src="${roleImg}" alt="${titleObj.t}">` : ``}
              <div style="font-weight:700; margin-top:6px">称号：${titleObj.t}</div>
              <div class="level-display">${lvLabel}：<span>Lv${String(level).padStart(2,'0')}</span>　ジョブ：${titleObj.role}</div>
              <div class="role-comment">${roleComment}</div>
              <div class="radar-wrap"><canvas id="radar"></canvas></div>
              <div class="disclaimer">
                ※ この結果は自己回答に基づく<strong>簡易チェック</strong>です。<br>
                医学的な診断・評価の提供を目的としたものではありません。体調や生活に困りごとがある場合は、医療・専門機関等へご相談ください。
              </div>
            </div>

            <div class="card">
              <h3>各特性のレベル</h3>
              <div class="level-grid">
                ${renderAxisLevelBadges(radar)}
              </div>
            </div>

            ${ overall==='balanced' && maxAny<=25 ? renderLowOverallCard() : renderAxisFeedback(radar) }

            <div class="card share">
              <div style="font-weight:700;">結果をシェア</div>
              <div class="buttons">
                <button id="shareXlink"  class="button x">X でシェア</button>
                <button id="shareFBlink" class="button fb">Facebook でシェア</button>
              </div>
              <div class="small muted" style="text-align:center">
                改行と空行で読みやすく整形された短文（可能な限り140字以内）＋短いリンクで投稿します。
              </div>
              <div style="margin-top:10px; text-align:center">
                <button id="savePngBtn" class="button">結果を画像保存（PNG）</button>
              </div>
              <div style="margin-top:8px; text-align:center"><button id="retryBtn" class="button">もう一度調べる</button></div>
            </div>

            <div class="card cta">
              <div style="display:grid; gap:16px; grid-template-columns:1fr; align-items:start">
                <img class="seminar-banner" src="images/0823seminar.png" alt="オンラインセミナー 8/23 バナー">
                <div>
                  <h3 style="color:#1e3a8a;">保護者向け｜感覚過敏の子・不登校の子を支える具体策（${SEMINAR_DATE} オンライン）</h3>
                  <p>KANKAKUクエストの結果、あなた（/お子さん）は <strong>「称号：${titleObj.t}」</strong>（Lv${String(level).padStart(2,'0')}）。その特徴に合わせて、日常の「しんどい」を軽くするヒントを保護者目線でお伝えします。</p>
                  <ul>
                    <li>感覚過敏が学校生活に与える影響と見立て方（音・光・衣服・におい・食事・温度/痛み・動き）</li>
                    <li>家で今日からできる環境調整と声かけ（朝の準備、通学/在宅の工夫）</li>
                    <li>学校・支援先への伝え方（合理的配慮のお願い文例、先生への共有ポイント）</li>
                    <li>不登校期の過ごし方と、復帰／進路選択に向けたステップ</li>
                  </ul>
                  <p><strong>特別講師：加藤 路瑛（感覚過敏研究所 所長）</strong><br>
                     <strong>共催・進行：まなクロ にっしー（元教員／不登校支援者）</strong></p>
                  <div style="margin-top:10px">
                    <a class="button primary" target="_blank" href="${SEMINAR_URL}">申し込みページ（Googleフォーム）</a>
                  </div>
                </div>
              </div>
            </div>
          </div>`;

        // レーダーチャート（CDN失敗時フォールバック込み）
        const ctx = document.getElementById('radar');
        if (window.Chart && ctx) {
          new Chart(ctx, {
            type: 'radar',
            data: {
              labels: radar.map(d=>d.axis),
              datasets: [
                { label:'過敏', data: radar.map(d=>d.hyper), fill:true, borderColor:'#111827', backgroundColor:'rgba(17,24,39,0.35)' },
                { label:'鈍麻', data: radar.map(d=>d.hypo),  fill:true, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.25)' },
              ]
            },
            options: { responsive:true, maintainAspectRatio:false, scales:{ r:{ suggestedMin:0, suggestedMax:100, pointLabels:{ font:{ size:(window.matchMedia('(max-width:480px)').matches ? 12 : 13) } }, ticks:{ display:false } } }, plugins:{ legend:{position:'bottom', labels:{ boxWidth:12, boxHeight:12, font:{ size:(window.matchMedia('(max-width:480px)').matches ? 12 : 13) } } } } }
          });
        } else if (ctx) {
          const fallback = document.createElement('div');
          fallback.className = 'small muted';
          fallback.style.textAlign = 'center';
          fallback.style.marginTop = '8px';
          fallback.textContent = '（チャートを表示できませんでした）';
          ctx.parentNode.replaceWith(fallback);
        }

        // 共有
        const shortText = buildShortShareText({ title: titleObj.t, level, overall, dominant });
        document.getElementById('shareXlink').onclick = () => {
          const t = encodeURIComponent(shortText);
          window.open(`https://x.com/intent/tweet?text=${t}`,'_blank');
        };
        document.getElementById('shareFBlink').onclick = () => {
          const u = encodeURIComponent(baseURL());
          window.open(`https://www.facebook.com/sharer/sharer.php?u=${u}`,'_blank');
        };

        // PNG保存
        const saveBtn = document.getElementById('savePngBtn');
        if (saveBtn) {
          saveBtn.onclick = () => saveResultPng({
            title: titleObj.t,
            level,
            roleImgSrc: roleImg,
            chartCanvasId: 'radar'
          });
        }

        document.getElementById('retryBtn').onclick = () => { qs=[]; answers={}; index=0; renderStart(); };
        window.scrollTo({top:0, behavior:'smooth'});
      }

      /* ================ 各特性Lvバッジ ================ */
      function renderAxisLevelBadges(radar){
        return radar.map(d=>{
          const mode = d.hyper>d.hypo ? '過敏' : (d.hypo>d.hyper ? '鈍麻' : '同程度');
          const lv = pctToLv(Math.max(d.hyper, d.hypo)); // 0–99
          return `
            <div class="level-item">
              <div><strong>${d.axis}</strong><span class="chip">${mode}</span></div>
              <div class="lv">Lv${String(lv).padStart(2,'0')}</div>
            </div>
          `;
        }).join('');
      }

      /* ================ ロジック ================ */
      function pickQuestions(){
        const byAxis = Object.fromEntries(AXES.map(a=>[a.key,{hyper:[],hypo:[]}])); 
        BANK.forEach(q => byAxis[q.axis][q.trait].push(q));
        const picked = [];
        AXES.forEach(ax=>{
          const H = shuffle(byAxis[ax.key].hyper).slice(0,2);
          const Y = shuffle(byAxis[ax.key].hypo ).slice(0,2);
          picked.push(...H, ...Y);
        });
        return shuffle(picked);
      }

      // フィッシャー–イェーツシャッフル
      function shuffle(arr){
        const a = arr.slice();
        for(let i=a.length-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          [a[i],a[j]] = [a[j],a[i]];
        }
        return a;
      }

      // p=0–100 → Lv=0–99（少し緩やか）
      const pctToLv = p => Math.min(99, Math.max(0, Math.floor(Math.pow(p/100, 1.15) * 99)));

      // スコア計算（非線形ウェイト）＋ 両極端（dual）判定
      function calcScores(questions, answers){
        const sums = Object.fromEntries(AXES.map(a=>[a.key,{h:0,y:0,hc:0,yc:0}]));
        questions.forEach(q=>{
          const v = answers[q.id];
          if(v==null) return;
          const w = LIKERT_WEIGHT[v] ?? 0;
          if(q.trait==='hyper'){sums[q.axis].h += w; sums[q.axis].hc++;}
          else                 {sums[q.axis].y += w; sums[q.axis].yc++;}
        });

        const radar = AXES.map(ax=>{
          const maxH = Math.max(1, sums[ax.key].hc * 1.0);
          const maxY = Math.max(1, sums[ax.key].yc * 1.0);
          const hyper = Math.round((sums[ax.key].h / maxH) * 100);
          const hypo  = Math.round((sums[ax.key].y / maxY) * 100);
          return { axis: ax.label, axisKey: ax.key, hyper, hypo };
        });

        const hyperAvg = Math.round(radar.reduce((a,d)=>a+d.hyper,0)/radar.length);
        const hypoAvg  = Math.round(radar.reduce((a,d)=>a+d.hypo,0)/radar.length);
        const maxAny   = Math.max(...radar.map(d=>Math.max(d.hyper,d.hypo)));
        const maxHyper = Math.max(...radar.map(d=>d.hyper));
        const maxHypo  = Math.max(...radar.map(d=>d.hypo));

        const EPS = 6;
        const LOW = 25;
        const MID = 55;
        const DOM_GAP = 8;

        let overall;
        if (maxHyper >= DUAL_THRESHOLD && maxHypo >= DUAL_THRESHOLD) {
          overall = 'dual';
        } else if (maxAny <= LOW) {
          overall = 'balanced';
        } else if (Math.abs(hyperAvg - hypoAvg) <= EPS && maxAny < MID) {
          overall = 'balanced';
        } else {
          overall = (hyperAvg > hypoAvg) ? 'hyper' : 'hypo';
        }

        let dominantKey = radar[0].axisKey, best=-1;
        radar.forEach(d=>{ const m=Math.max(d.hyper,d.hypo); if(m>best){best=m; dominantKey=d.axisKey;} });

        if (overall === 'balanced') {
          const domProbe = radar.find(r=>r.axisKey===dominantKey);
          if (domProbe) {
            const gap = Math.abs(domProbe.hyper - domProbe.hypo);
            const domMax = Math.max(domProbe.hyper, domProbe.hypo);
            if (gap >= DOM_GAP && domMax >= 45) {
              overall = (domProbe.hyper > domProbe.hypo) ? 'hyper' : 'hypo';
            }
          }
        }

        const dom = radar.find(r=>r.axisKey===dominantKey);
        const lvDominant = pctToLv(Math.max(dom.hyper, dom.hypo));
        const lvBalanced = pctToLv(100 - maxAny);
        const lvDual     = pctToLv(Math.min(maxHyper, maxHypo));

        return { radar, hyperAvg, hypoAvg, overall, dominant: dominantKey, maxAny, lvDominant, lvBalanced, maxHyper, maxHypo, lvDual };
      }

      function renderAxisFeedback(radar){
        const scored = radar.map(d=>({ key:d.axisKey, label:d.axis, hyper:d.hyper, hypo:d.hypo }));
        const picks = scored.filter(s=>Math.max(s.hyper,s.hypo)>=60)
                            .sort((a,b)=>Math.max(b.hyper,b.hypo)-Math.max(a.hyper,a.hypo));
        const list = (picks.length? picks: scored.sort((a,b)=>Math.max(b.hyper,b.hypo)-Math.max(a.hyper,a.hypo)).slice(0,3));
        return list.map(s=>{
          const mode = s.hyper> s.hypo ? 'hyper' : (s.hypo> s.hyper? 'hypo':'mix');
          const book = COMMENT_BOOK[s.key];
          const strong = mode==='mix'? [...book.hyper.strong,...book.hypo.strong].slice(0,2) : book[mode].strong;
          const challenge = mode==='mix'? [...book.hyper.challenge,...book.hypo.challenge].slice(0,2) : book[mode].challenge;
          const tips = mode==='mix'? [...book.hyper.tips,...book.hypo.tips].slice(0,3) : book[mode].tips;
          return `
            <div class="card">
              <h3>${s.label}</h3>
              <div class="small muted">過敏:${s.hyper}% / 鈍麻:${s.hypo}%</div>
              <div class="cols" style="margin-top:8px">
                <div><div style="font-weight:600; margin-bottom:6px">得意なこと（強み）</div><ul>${strong.map(x=>`<li>${x}</li>`).join('')}</ul></div>
                <div><div style="font-weight:600; margin-bottom:6px">苦手になりやすいこと</div><ul>${challenge.map(x=>`<li>${x}</li>`).join('')}</ul></div>
                <div><div style="font-weight:600; margin-bottom:6px">対処法のヒント</div><ul>${tips.map(x=>`<li>${x}</li>`).join('')}</ul></div>
              </div>
            </div>`;
        }).join('');
      }

      const COMMENT_BOOK = {
        hearing: {
          hyper: { strong:['微かな音の変化に気づける観察力'], challenge:['人混みや大音量の場所で疲れやすい'], tips:['ノイズキャンセリング/耳栓の活用','静かな席や時間帯を選ぶ','通知音量の微調整'] },
          hypo:  { strong:['賑やかな環境でも集中しやすい'], challenge:['呼びかけやアナウンスを聞き逃しやすい'], tips:['バイブ/光での通知','視覚サインの併用','重要連絡は文字ベースで受け取る'] }
        },
        vision: {
          hyper: { strong:['細かな差異にすぐ気づける洞察力'], challenge:['強い光/ちらつきで疲れやすい'], tips:['遮光/偏光レンズ','画面の明るさ/配色を調整','紙面作業をこまめに挟む'] },
          hypo:  { strong:['暗所で落ち着いて動ける'], challenge:['細部の変化に気づきにくい'], tips:['コントラスト強調','要点のマーキング','タスク前のチェックリスト'] }
        },
        touch: {
          hyper: { strong:['素材/肌触りへの審美眼'], challenge:['タグ/チクチク/ベタつきがストレス'], tips:['肌当たりの良い素材選び','タグカット/裏返し着用','ウェットティッシュ常備'] },
          hypo:  { strong:['圧や重みで落ち着きやすい'], challenge:['小さなケガや汚れに気づきにくい'], tips:['定期的なボディチェック','加重ブランケットの活用','触覚入力のバランス'] }
        },
        smell: {
          hyper: { strong:['香りの違いを見分ける能力'], challenge:['香料が混ざる場所が苦手'], tips:['マスク/アロマでリセット','換気の良い席を確保','香り強い洗剤を避ける'] },
          hypo:  { strong:['強い匂いにも冷静'], challenge:['危険な臭いに気づきにくい'], tips:['期限表示の確認習慣','他者に確認を頼む','におい以外の衛生指標を使う'] }
        },
        taste: {
          hyper: { strong:['味の違いを楽しむ繊細さ'], challenge:['食べられる品目が限られやすい'], tips:['食感/香り単位での置き換え','調味/調理法の微調整','小さな一歩の試食'] },
          hypo:  { strong:['刺激的な味を楽しむ冒険心'], challenge:['塩分/辛味の過剰に注意'], tips:['栄養バランス表の活用','味以外（温度/見た目）の満足要素を増やす','医療的制限がある場合は専門家相談'] }
        },
        tempPain: {
          hyper: { strong:['体調変化の早期察知'], challenge:['気温/痛みの変化で消耗しやすい'], tips:['重ね着/冷温アイテム','作業時間を短ブロック化','こまめな休憩'] },
          hypo:  { strong:['幅広い環境に適応できる'], challenge:['熱中症/低体温に気づきにくい'], tips:['タイマーで水分/休憩を促す','活動ログで体調を可視化','危険温度の客観指標を使う'] }
        },
        movement: {
          hyper: { strong:['バランス変化に敏感'], challenge:['乗り物酔い/人混みがつらい'], tips:['混雑回避ルート','安定した姿勢/視点固定','乗り物は前方/風通し良い席'] },
          hypo:  { strong:['スリル/運動を楽しめる'], challenge:['危険察知が遅れがち'], tips:['安全ルールの事前確認','プロテクターの使用','段階的に刺激レベルを上げる'] }
        },
      };

      function renderLowOverallCard(){
        return `
          <div class="card">
            <h3>今回のまとめ</h3>
            <p class="muted">全体的に大きな偏りは見られませんでした。日によって「少し気になる」「今日は平気」など、ゆるやかな変化があるタイプかもしれません。</p>
            <ul>
              <li>困りごとが少ない時は、そのままの環境でOK</li>
              <li>疲れている日は、音や光など一つだけでもコントロールできると楽に</li>
              <li>「しんどさログ」をつけると自分の傾向が見つけやすい</li>
            </ul>
          </div>
        `;
      }

      /* ================ 便利関数（ボタン文言など） ================ */
      function formatJPDate(iso){
        const d = new Date(iso + 'T00:00:00');
        const w = ['日','月','火','水','木','金','土'][d.getDay()];
        return `${d.getMonth()+1}/${d.getDate()}(${w})`;
      }
      function updateSeminarButton(){
        const btn = document.getElementById('seminarBtnTop');
        if(!btn) return;
        const today = new Date();
        const eventDate = new Date(SEMINAR_DATE + 'T23:59:59');
        if (today <= eventDate) {
          btn.textContent = `${formatJPDate(SEMINAR_DATE)} セミナーを見る`;
          btn.href = SEMINAR_URL;
        } else {
          btn.textContent = 'アーカイブを見る';
          btn.href = SEMINAR_URL; // 適宜変更
        }
      }
      function preload(srcs=[]){
        srcs.forEach(s => { const i = new Image(); i.src = s; });
      }

      // PNG保存ユーティリティ
      async function saveResultPng({ title, level, roleImgSrc, chartCanvasId = 'radar' }) {
        try{
          const roleImg = await loadImage(roleImgSrc);
          const chart = document.getElementById(chartCanvasId);
          if (!chart) { alert('チャートが見つかりませんでした'); return; }

          const W = 1080, P = 48;
          const out = document.createElement('canvas');
          out.width = W;
          out.height = 1600;
          const g = out.getContext('2d');

          g.fillStyle = '#ffffff'; g.fillRect(0,0,out.width,out.height);
          let y = P;

          g.fillStyle = '#0f172a';
          g.font = 'bold 48px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
          g.fillText('KANKAKUクエスト 診断結果', P, y); y += 64;

          g.font = 'bold 40px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
          g.fillText(`称号：${title}`, P, y); y += 52;
          g.font = '600 36px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
          g.fillText(`レベル：Lv${String(level).padStart(2,'0')}`, P, y); y += 36 + 24;

          const roleW = Math.min(W - P*2, 560);
          const roleH = Math.round(roleW * (roleImg.height/roleImg.width));
          g.drawImage(roleImg, P, y, roleW, roleH); y += roleH + 32;

          const chartW = Math.min(W - P*2, 720);
          g.drawImage(chart, P, y, chartW, 540); y += 540 + 28;

          g.fillStyle = '#64748b';
          g.font = '24px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
          wrapText(g, '※ この結果は自己回答に基づく簡易チェックです。医学的な診断を提供するものではありません。', P, y, W - P*2, 30);

          const dataUrl = out.toDataURL('image/png');

          // 共有APIが使えれば優先
          try{
            const file = await dataUrlToFile(dataUrl, 'kankaku-result.png');
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({ files: [file], title: 'KANKAKUクエスト結果' });
              return;
            }
          }catch(_){}

          const a = document.createElement('a');
          a.href = dataUrl;
          a.download = 'kankaku-result.png';
          document.body.appendChild(a);
          a.click();
          a.remove();
        }catch(e){
          console.error(e);
          alert('画像の保存に失敗しました。ページを再読み込みして再試行してください。');
        }
      }
      function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        const chars = text.split('');
        let line = '';
        for (let i=0;i<chars.length;i++){
          const test = line + chars[i];
          if (ctx.measureText(test).width > maxWidth && i>0){
            ctx.fillText(line, x, y);
            line = chars[i];
            y += lineHeight;
          } else {
            line = test;
          }
        }
        ctx.fillText(line, x, y);
      }
      function loadImage(src) {
        return new Promise((res, rej) => {
          const img = new Image();
          img.onload = () => res(img);
          img.onerror = rej;
          // 同一オリジン配信なので crossOrigin は不要
          img.src = src;
        });
      }
      async function dataUrlToFile(dataUrl, filename){
        const res = await fetch(dataUrl);
        const blob = await res.blob();
        return new File([blob], filename, { type: 'image/png' });
      }

      /* ================ 初期化（ロゴはタップ無効のまま） ================ */
      window.addEventListener('DOMContentLoaded', () => {
        const btnTop = document.getElementById('seminarBtnTop');
        if (btnTop) btnTop.href = SEMINAR_URL;

        updateSeminarButton();

        const roleImgs = [
          IMAGES.balanced, IMAGES.dual, IMAGES.title,
          ...Object.values(IMAGES.rolesHyper),
          ...Object.values(IMAGES.rolesHypo)
        ].filter(Boolean);
        preload(roleImgs);

        renderStart();
      });
    </script>
  </body>
</html>
