<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KANKAKUクエスト — あなたの感覚ジョブ診断</title>
    <!-- Chart.js（レーダーチャート用） -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      :root{
        --bg:#f7f8fb; --card:#fff; --ink:#0f172a; --muted:#616b7c; --brand:#2563eb; --brand2:#0f172a;
        --ring:#e5e7eb; --good:#16a34a; --warn:#ea580c;
      }
      *{box-sizing:border-box}
      body{margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--ink); background:linear-gradient(#f7f8fb,#fff)}
      .container{max-width:960px; margin:0 auto; padding:16px}
      header{position:sticky; top:0; background:#ffffffbb; backdrop-filter:saturate(1.1) blur(6px); border-bottom:1px solid var(--ring)}
      header .bar{display:flex; align-items:center; justify-content:space-between; padding:10px 16px}
      .brand{display:flex; gap:10px; align-items:center; cursor:pointer; text-decoration:none; color:inherit}
      .brand .logo{width:32px;height:32px;border-radius:10px;background:var(--brand2);color:#fff;display:grid;place-items:center;font-weight:700}
      .button{border:1px solid var(--ring); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer}
      .button.primary{background:var(--brand); color:#fff; border-color:transparent}
      .button.success{background:var(--good); color:#fff; border-color:transparent} /* 子どもボタンを緑 */
      .button.x{background:#111; color:#fff; border-color:#111}
      .button.fb{background:#1877F2; color:#fff; border-color:#1877F2}
      .button[disabled]{opacity:.5; cursor:not-allowed}
      .grid{display:grid; gap:16px}
      .card{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:18px}
      .hero img{width:70%; max-width:800px; margin:0 auto; display:block} /* タイトル画像70% */
      .progress{height:8px; background:#e5e7eb; border-radius:99px; overflow:hidden}
      .progress > div{height:100%; background:var(--brand2)}
      .likert{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:16px}
      .likert button{padding:10px 14px; border:1px solid var(--ring); border-radius:12px; background:#fff8db} /* 薄い黄色 */
      .likert button:hover{background:#ffefaf}
      .likert button.active{background:#fde68a; border-color:#facc15}
      .cols{display:grid; gap:16px}
      @media(min-width:900px){.cols{grid-template-columns:repeat(3,1fr)}}
      .small{font-size:12px; color:#475569}
      .muted{color:var(--muted)}
      .badge{display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background:#eef2ff}
      .center{text-align:center}
      img.role{width:160px; height:auto; display:block; margin:8px auto 0}
      footer{color:#6b7280; font-size:12px; padding:24px 16px}
      .cta{background:#eff6ff; border:1px solid #bfdbfe}
      .start-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; margin-top:12px}
      .cta-grid{display:grid; gap:16px; align-items:start; grid-template-columns:1fr}
      @media(min-width:900px){.cta-grid{grid-template-columns:280px 1fr}}
      .seminar-banner{width:100%; height:auto; border-radius:12px; border:1px solid #bfdbfe}
      .cta h3{margin:8px 0 10px}
      .cta p{margin:8px 0}
      .cta ul{margin:6px 0 0 1.2em}
      .share{display:grid; gap:10px; justify-items:center}
      .share .buttons{display:flex; flex-wrap:wrap; gap:8px; justify-content:center}
      .level-grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
      @media(min-width:700px){.level-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
      .level-item{border:1px solid var(--ring); border-radius:12px; padding:10px; background:#fff}
      .level-item .lv{font-weight:700}
      .chip{display:inline-block; padding:2px 8px; font-size:12px; border-radius:999px; background:#f1f5f9; margin-left:6px}
    </style>
  </head>
  <body>
    <header>
      <div class="bar container">
        <a id="homeLink" class="brand">
          <div class="logo">Q</div><div style="font-weight:700">KANKAKUクエスト</div>
        </a>
        <a id="seminarBtnTop" class="button primary" target="_blank" href="#">8/23 セミナーを見る</a>
      </div>
    </header>

    <main id="app" class="container"></main>

    <footer class="container">
      <div style="margin-bottom:6px;">by <strong>MANAKURO</strong></div>
      プライバシー：回答は端末内で処理され、同意なく保存されません。
    </footer>

    <script>
      /* ================= 設定 ================= */
      const SEMINAR_DATE = '2025-08-23';
      const SEMINAR_URL  = 'https://forms.gle/hWcV6LZDvR2S9wX88';

      // 画像パス（hyper/hypo で分岐）
      const IMAGES = {
        title: 'images/title-image.png',
        rolesHyper: {
          hearing:   'images/job-elf-scout.png',
          vision:    'images/job-wizard.png',
          touch:     'images/job-guardian.png',
          smell:     'images/job-poison-appraiser.png',
          taste:     'images/job-gourmet.png',
          tempPain:  'images/job-weather-mage.png',
          movement:  'images/job-knight.png'
        },
        rolesHypo: {
          hearing:   'images/job-hearing-hypo.png',
          vision:    'images/job-vision-hypo.png',
          touch:     'images/job-touch-hypo.png',
          smell:     'images/job-smell-hypo.png',
          taste:     'images/job-taste-hypo.png',
          tempPain:  'images/job-tempPain-hypo.png',
          movement:  'images/job-movement-hypo.png'
        },
        balanced: 'images/job-nomal.png' // バランス型：ノーマライザー
      };

      // 称号テーブル
      const TITLES = {
        hyper: {
          hearing:  { t: 'エルフ耳の斥候（スカウト）', role: 'スカウト' },
          vision:   { t: '洞察の魔法使い（メイジ）', role: 'メイジ' },
          touch:    { t: '結界の守護者（ガーディアン）', role: 'ガーディアン' },
          smell:    { t: '毒の鑑定士（アルケミスト）', role: 'アルケミスト' },
          taste:    { t: '美食の王子／姫（グルメ）', role: 'グルメ' },
          tempPain: { t: '気候予報士（メイジ）', role: 'メイジ' },
          movement: { t: '揺れセンサー搭載者（ナイト）', role: 'ナイト' },
        },
        hypo: {
          hearing:  { t: '戦場の鼓手（バード）', role: 'バード' },
          vision:   { t: '月影のハンター（ハンター）', role: 'ハンター' },
          touch:    { t: '鉄皮のモンク（モンク）', role: 'モンク' },
          smell:    { t: '炉心の鍛冶師（ブラックスミス）', role: 'ブラックスミス' },
          taste:    { t: '香辛の冒険家（エクスプローラー）', role: 'エクスプローラー' },
          tempPain: { t: '四季渡りのノマド（ノマド）', role: 'ノマド' },
          movement: { t: '竜騎のランサー（ドラグーン）', role: 'ドラグーン' },
        },
      };

      const AXES = [
        { key: 'hearing',  label: '聴覚' },
        { key: 'vision',   label: '視覚' },
        { key: 'touch',    label: '触覚' },
        { key: 'smell',    label: '嗅覚' },
        { key: 'taste',    label: '味覚' },
        { key: 'tempPain', label: '温度/痛み' },
        { key: 'movement', label: '動き' },
      ];

      /* ================ 質問 ================ */
      const BANK = [
        // 聴覚
        { id: 'h_h_1', axis: 'hearing', trait: 'hyper', child: '教室のざわざわがつらく、耳をふさぎたくなることがある', adult: '店内やオフィスのざわめきで集中が切れやすい' },
        { id: 'h_h_2', axis: 'hearing', trait: 'hyper', child: '突然の大きな音に強くびっくりする', adult: 'アラームや工事音などの大きな音が強いストレスになる' },
        { id: 'h_y_1', axis: 'hearing', trait: 'hypo',  child: '呼ばれても気づかず、何度も呼ばれることがある', adult: 'アナウンスや声に反応が遅れることがある' },
        // 視覚
        { id: 'v_h_1', axis: 'vision', trait: 'hyper', child: '画面のちらつきや速い動きがしんどい', adult: '高コントラスト/ちらつきで疲労や頭痛が出やすい' },
        { id: 'v_h_2', axis: 'vision', trait: 'hyper', child: '蛍光灯や日差しがまぶしくて目を細める', adult: '強い照明や画面光がつらく、遮光が欲しくなる' },
        { id: 'v_y_1', axis: 'vision', trait: 'hypo',  child: '暗い場所が好き/暗くても平気で動ける', adult: '暗い場所でも困らないことが多い' },
        // 触覚
        { id: 't_h_1', axis: 'touch', trait: 'hyper', child: 'タグやチクチクする服が苦手', adult: 'ウール/化繊/タグなどの刺激が気になる' },
        { id: 't_h_2', axis: 'touch', trait: 'hyper', child: '手が少し汚れただけでもすぐ拭きたくなる', adult: '手や衣服のベタつきが強いストレスになる' },
        { id: 't_y_1', axis: 'touch', trait: 'hypo',  child: 'ぎゅっと抱きしめられると落ち着くことがある', adult: '圧刺激（加重ブランケット等）で落ち着くことがある' },
        // 嗅覚
        { id: 's_h_1', axis: 'smell', trait: 'hyper', child: '柔軟剤や香水のにおいが気になって離れたくなる', adult: '香料や食品のにおいに敏感で避けたくなる' },
        { id: 's_h_2', axis: 'smell', trait: 'hyper', child: '他の人が気づかないにおいを感じ取る', adult: '微かなにおいに気づいて集中が途切れやすい' },
        { id: 's_y_1', axis: 'smell', trait: 'hypo',  child: 'においの強い食べ物でも平気', adult: '強いにおいでも平気なことが多い' },
        // 味覚
        { id: 'ta_h_1', axis: 'taste', trait: 'hyper', child: '食べられるものが限られがち（食感/香りが理由）', adult: '繊細な味の差を感じ取り、好みがはっきりしている' },
        { id: 'ta_h_2', axis: 'taste', trait: 'hyper', child: '味や食感の変化に敏感', adult: '微妙な味の違いにすぐ気づく' },
        { id: 'ta_y_1', axis: 'taste', trait: 'hypo',  child: '濃い味やスパイスの強い料理を好む', adult: '刺激の強い味を好みやすい' },
        // 温度/痛み
        { id: 'tp_h_1', axis: 'tempPain', trait: 'hyper', child: '暑さ/寒さに参りやすい（こまめな調整が必要）', adult: '室温や風の変化に敏感で不快になりやすい' },
        { id: 'tp_h_2', axis: 'tempPain', trait: 'hyper', child: '小さな擦り傷でも強く痛がることがある', adult: '軽い痛み/違和感でも集中が途切れることがある' },
        { id: 'tp_y_1', axis: 'tempPain', trait: 'hypo',  child: '暑さ寒さに鈍く、上着を忘れがち', adult: '温度変化に気づくのが遅れがち' },
        // 動き
        { id: 'm_h_1', axis: 'movement', trait: 'hyper', child: '人混みや揺れる場所が苦手', adult: '満員電車やVRで酔いやすい' },
        { id: 'm_h_2', axis: 'movement', trait: 'hyper', child: '突然の動きの変化が苦手', adult: '高速移動や急加速がしんどい' },
        { id: 'm_y_1', axis: 'movement', trait: 'hypo',  child: 'クルクル回る/ジャンプなど強い刺激を求める', adult: '強い運動やスリルを求めがち' },
      ];

      const COMMENT_BOOK = {
        hearing: {
          hyper: { strong:['微かな音の変化に気づける観察力'], challenge:['人混みや大音量の場所で疲れやすい'], tips:['ノイズキャンセリング/耳栓の活用','静かな席や時間帯を選ぶ','通知音量の微調整'] },
          hypo:  { strong:['賑やかな環境でも集中しやすい'], challenge:['呼びかけやアナウンスを聞き逃しやすい'], tips:['バイブ/光での通知','視覚サインの併用','重要連絡は文字ベースで受け取る'] }
        },
        vision: {
          hyper: { strong:['細かな差異にすぐ気づける洞察力'], challenge:['強い光/ちらつきで疲れやすい'], tips:['遮光/偏光レンズ','画面の明るさ/配色を調整','紙面作業をこまめに挟む'] },
          hypo:  { strong:['暗所で落ち着いて動ける'], challenge:['細部の変化に気づきにくい'], tips:['コントラスト強調','要点のマーキング','タスク前のチェックリスト'] }
        },
        touch: {
          hyper: { strong:['素材/肌触りへの審美眼'], challenge:['タグ/チクチク/ベタつきがストレス'], tips:['肌当たりの良い素材選び','タグカット/裏返し着用','ウェットティッシュ常備'] },
          hypo:  { strong:['圧や重みで落ち着きやすい'], challenge:['小さなケガや汚れに気づきにくい'], tips:['定期的なボディチェック','加重ブランケットの活用','触覚入力のバランス'] }
        },
        smell: {
          hyper: { strong:['香りの違いを見分ける能力'], challenge:['香料が混ざる場所が苦手'], tips:['マスク/アロマでリセット','換気の良い席を確保','香り強い洗剤を避ける'] },
          hypo:  { strong:['強い匂いにも冷静'], challenge:['危険な臭いに気づきにくい'], tips:['期限表示の確認習慣','他者に確認を頼む','におい以外の衛生指標を使う'] }
        },
        taste: {
          hyper: { strong:['味の違いを楽しむ繊細さ'], challenge:['食べられる品目が限られやすい'], tips:['食感/香り単位での置き換え','調味/調理法の微調整','小さな一歩の試食'] },
          hypo:  { strong:['刺激的な味を楽しむ冒険心'], challenge:['塩分/辛味の過剰に注意'], tips:['栄養バランス表の活用','味以外（温度/見た目）の満足要素を増やす','医療的制限がある場合は専門家相談'] }
        },
        tempPain: {
          hyper: { strong:['体調変化の早期察知'], challenge:['気温/痛みの変化で消耗しやすい'], tips:['重ね着/冷温アイテム','作業時間を短ブロック化','こまめな休憩'] },
          hypo:  { strong:['幅広い環境に適応できる'], challenge:['熱中症/低体温に気づきにくい'], tips:['タイマーで水分/休憩を促す','活動ログで体調を可視化','危険温度の客観指標を使う'] }
        },
        movement: {
          hyper: { strong:['バランス変化に敏感'], challenge:['乗り物酔い/人混みがつらい'], tips:['混雑回避ルート','安定した姿勢/視点固定','乗り物は前方/風通し良い席'] },
          hypo:  { strong:['スリル/運動を楽しめる'], challenge:['危険察知が遅れがち'], tips:['安全ルールの事前確認','プロテクターの使用','段階的に刺激レベルを上げる'] }
        },
      };

      const LIKERT = [
        { v:0, label:'まったくない' },
        { v:1, label:'すこし' },
        { v:2, label:'ときどき' },
        { v:3, label:'よくある' },
        { v:4, label:'とても強い' },
      ];
      const MODE_MAP = { easy:12, normal:18, deep:30 };

      /* ================ 状態 ================ */
      let who = null;       // 'self' | 'child'
      let phrasing = 'adult'; // 表現は固定（子ども向け言い回しは使わない）
      let mode = null;      // 'easy'|'normal'|'deep'
      let qs = []; let answers = {}; let index = 0;

      const app = document.getElementById('app');

      /* ================ 画面 ================ */
      function renderStart(){
        app.innerHTML = `
          <div class="grid">
            <div class="card hero"><img src="${IMAGES.title}" alt="KANKAKUクエスト タイトル"></div>
            <div class="card" style="text-align:center">
              <h1>あなたの感覚ジョブ診断</h1>
              <p class="muted">
                簡単な質問に答えるだけで、聴覚・視覚・触覚・嗅覚・味覚・温度/痛み・<strong>動き</strong>の感じ方を見える化。<br>
                最後にレーダーチャートとRPG風の称号が表示されます。
              </p>
              <div class="small">※ これは医療的診断ではありません。日々の対話や工夫のきっかけとしてご活用ください。</div>
              <div class="start-actions">
                <button class="button primary" id="startSelf">自分自身について調べる</button>
                <button class="button success" id="startChild">子どもについて調べる</button>
              </div>
            </div>
          </div>`;
        document.getElementById('startSelf').onclick=()=>{who='self'; phrasing='adult'; renderMode();};
        document.getElementById('startChild').onclick=()=>{who='child'; phrasing='adult'; renderMode();};
        window.scrollTo({top:0, behavior:'smooth'});
      }

      function renderMode(){
        app.innerHTML = `
          <div class="card" style="text-align:center">
            <h2>調べ方を選ぶ</h2>
            <div class="muted">各軸の質問数が変わります。時間に合わせてどうぞ。</div>
            <div style="display:grid; gap:10px; grid-template-columns:repeat(3, minmax(0,1fr)); margin-top:12px">
              <button class="button" id="mEasy">簡単<br><span class="small">各軸2問（約2–3分）</span></button>
              <button class="button" id="mNormal">普通<br><span class="small">各軸3問（約4–6分）</span></button>
              <button class="button" id="mDeep">しっかり<br><span class="small">各軸4–5問（約7–10分）</span></button>
            </div>
          </div>`;
        document.getElementById('mEasy').onclick=()=>{mode='easy'; startQuestions();};
        document.getElementById('mNormal').onclick=()=>{mode='normal'; startQuestions();};
        document.getElementById('mDeep').onclick=()=>{mode='deep'; startQuestions();};
        window.scrollTo({top:0, behavior:'smooth'});
      }

      function startQuestions(){
        qs = pickQuestions(mode);
        answers = {}; index = 0;
        renderQuestion();
      }

      function renderQuestion(){
        const total = qs.length;
        const q = qs[index];
        const text = phrasing==='child'? q.child : q.adult;
        const answered = answers[q.id];
        const progress = Math.round(Object.keys(answers).length/total*100);
        app.innerHTML = `
          <div class="grid">
            <div class="progress"><div style="width:${progress}%"></div></div>
            <div class="card" style="text-align:center">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px">
                <div><span class="badge">${AXES.find(a=>a.key===q.axis).label}</span></div>
                <div class="small">${index+1} / ${total}</div>
              </div>
              <div style="font-size:18px; margin-bottom:20px">${text}</div> <!-- 質問とボタンの間に余白 -->
              <div class="likert" id="likert"></div>
              <div style="display:flex; justify-content:space-between; margin-top:14px">
                <button class="button" id="prevBtn" ${index===0?'disabled':''}>もどる</button>
                <span></span>
              </div>
            </div>
          </div>`;
        const wrap = document.getElementById('likert');
        LIKERT.forEach(o=>{
          const btn = document.createElement('button');
          btn.textContent = o.label;
          btn.className='button';
          if(answered===o.v) btn.classList.add('active');
          btn.onclick=()=> selectAndNext(o.v);
          wrap.appendChild(btn);
        });
        document.getElementById('prevBtn').onclick=()=>{ if(index>0){ index--; renderQuestion(); } };
        window.scrollTo({top:0, behavior:'smooth'});
      }

      // 選択→即次へ
      function selectAndNext(value){
        const q = qs[index];
        answers[q.id] = value;
        const total = qs.length;
        if(index+1 < total){ index++; renderQuestion(); }
        else { renderResult(); }
      }

      /* ================ 結果 ================ */
      function renderResult(){
        const s = calcScores(qs, answers);
        const { radar, hyperAvg, hypoAvg, overall, dominant, maxAny, lvDominant, lvBalanced } = s;

        let titleObj = null, axisLabel = null, roleImg = null, level = null, lvLabel = 'Lv';
        if (overall === 'balanced') {
          titleObj = { t:'バランス型：ノーマライザー', role:'ノーマライザー' };
          axisLabel = 'バランス型';
          roleImg = IMAGES.balanced;
          level = lvBalanced;       // バランス度（0–99）
          lvLabel = 'Lv（バランス度）';
        } else {
          const axis = AXES.find(a=>a.key===dominant);
          axisLabel = axis ? axis.label : '';
          titleObj = TITLES[overall][dominant];
          roleImg = overall==='hyper' ? IMAGES.rolesHyper[dominant] : IMAGES.rolesHypo[dominant];
          level = lvDominant;       // 代表軸の強さ（0–99）
        }

        let headNote = '';
        if (overall === 'balanced' && maxAny <= 20) {
          headNote = '今回は大きな偏りは見つかりませんでした。状況や体調によって感じ方がゆるやかに変わる、柔軟タイプかもしれません。';
        } else if (overall === 'balanced') {
          headNote = `大きな偏りはありませんでした。比較的「${AXES.find(a=>a.key===dominant)?.label ?? '—'}」が気になりやすいかもしれません。`;
        } else {
          headNote = `いちばん特徴が強く出たのは「${axisLabel}」。全体としては<strong>${overall==='hyper'?'過敏':'鈍麻'}</strong>の傾向がやや高めでした。`;
        }

        const payload = { v:2, overall, dominant, axisLabel, title:titleObj.t, radar, level, lvLabel };
        const shareUrl = buildShareUrl(payload);

        app.innerHTML = `
          <div class="grid">
            <div class="card center">
              <h2>結果</h2>
              <div class="muted">${headNote}</div>
              ${roleImg ? `<img class="role" src="${roleImg}" alt="${titleObj.t}">` : ``}
              <div style="font-weight:700; margin-top:6px">称号：${titleObj.t}</div>
              <div class="small">${lvLabel}：<span style="font-weight:700">Lv${String(level).padStart(2,'0')}</span>　ジョブ：${titleObj.role}</div>
              <div style="height:360px; margin:14px auto 0; display:flex; align-items:center; justify-content:center; max-width:560px;">
                <canvas id="radar"></canvas>
              </div>
            </div>

            <div class="card">
              <h3>各特性のレベル</h3>
              <div class="level-grid">
                ${renderAxisLevelBadges(radar)}
              </div>
            </div>

            ${ overall==='balanced' && maxAny<=20 ? renderLowOverallCard() : renderAxisFeedback(radar) }

            <div class="card share">
              <div style="font-weight:700;">結果をシェア</div>
              <div class="buttons">
                <button id="shareXimg"  class="button x">X に画像付きで投稿</button>
                <button id="shareXlink" class="button">X（テキスト＋リンク）</button>
                <button id="shareFBimg" class="button fb">Facebook 画像付き</button>
                <button id="shareFBlink" class="button">Facebook（リンクのみ）</button>
              </div>
              <div class="small muted" style="text-align:center;max-width:760px">
                画像付き投稿は対応端末で動作します。できない場合は画像を保存しますので、各SNSでアップロードしてください。
              </div>
              <div style="margin-top:8px; text-align:center"><button id="retryBtn" class="button">もう一度調べる</button></div>
            </div>

            <div class="card cta">
              <div class="cta-grid">
                <img class="seminar-banner" src="images/0823seminar.png" alt="オンラインセミナー 8/23 バナー">
                <div>
                  <h3 style="color:#1e3a8a;">保護者向け｜感覚過敏の子・不登校の子を支える具体策（${SEMINAR_DATE} オンライン）</h3>
                  <p>KANKAKUクエストの結果、あなた（/お子さん）は <strong>「称号：${titleObj.t}」</strong>（${lvLabel}：Lv${String(level).padStart(2,'0')}）。その特徴に合わせて、日常の「しんどい」を軽くするヒントを保護者目線でお伝えします。</p>
                  <ul>
                    <li>感覚過敏が学校生活に与える影響と見立て方（音・光・衣服・におい・食事・温度/痛み・動き）</li>
                    <li>家で今日からできる環境調整と声かけ（朝の準備、通学/在宅の工夫）</li>
                    <li>学校・支援先への伝え方（合理的配慮のお願い文例、先生への共有ポイント）</li>
                    <li>不登校期の過ごし方と、復帰／進路選択に向けたステップ</li>
                  </ul>
                  <p><strong>特別講師：加藤 路瑛（感覚過敏研究所 所長）</strong><br>
                     <strong>共催・進行：まなクロ にっしー（元教員／不登校支援者）</strong></p>
                  <div style="margin-top:10px">
                    <a class="button primary" target="_blank" href="${SEMINAR_URL}">申し込みページ（Googleフォーム）</a>
                  </div>
                </div>
              </div>
            </div>
          </div>`;

        // チャート
        const ctx = document.getElementById('radar');
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: radar.map(d=>d.axis),
            datasets: [
              { label:'過敏', data: radar.map(d=>d.hyper), fill:true, borderColor:'#111827', backgroundColor:'rgba(17,24,39,0.35)' },
              { label:'鈍麻', data: radar.map(d=>d.hypo),  fill:true, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.25)' },
            ]
          },
          options: { scales:{ r:{ suggestedMin:0, suggestedMax:100 } }, plugins:{ legend:{position:'bottom'} } }
        });

        // 共有テキスト（やってみたくなるトーン）
        const axisLabelForShare = axisLabel || 'バランス型';
        const baseText1 = `感覚の特性を調べてみた｜称号「${titleObj.t}」 Lv${String(level).padStart(2,'0')}`;
        const baseText2 = `自分はどっち寄り？ 過敏？鈍麻？ 自分の感覚特性を調べてみよう！`;
        const shareText = `${baseText1}\n${baseText2}\n詳しくはこちら>> ${shareUrl}\n#KANKAKUクエスト #感覚過敏`;

        // 画像付き投稿の共通処理
        const shareImageFlow = async () => {
          const img = await buildShareImage({
            titleText: `${titleObj.t}  Lv${String(level).padStart(2,'0')}`,
            axisLabel: axisLabelForShare,
            leaning: (overall==='balanced' ? 'バランス' : ( (hyperAvg>=hypoAvg)?'過敏':'鈍麻' )),
            radarCanvas: ctx,
            roleImgSrc: (overall==='balanced'
                          ? IMAGES.balanced
                          : (overall==='hyper' ? IMAGES.rolesHyper[dominant] : IMAGES.rolesHypo[dominant]))
          });
          await shareOrDownloadImage(img.blob, 'kankaku-quest.png', shareText);
        };

        // X: テキスト+リンク
        document.getElementById('shareXlink').onclick = () => {
          const t = encodeURIComponent(`${baseText1}\n${baseText2}\n#KANKAKUクエスト #感覚過敏`);
          const u = encodeURIComponent(shareUrl);
          window.open(`https://twitter.com/intent/tweet?text=${t}&url=${u}`,'_blank');
        };
        // X: 画像付き
        document.getElementById('shareXimg').onclick = () => { shareImageFlow(); };

        // FB: リンクのみ
        document.getElementById('shareFBlink').onclick = () => {
          const u = encodeURIComponent(shareUrl);
          window.open(`https://www.facebook.com/sharer/sharer.php?u=${u}`,'_blank');
        };
        // FB: 画像付き
        document.getElementById('shareFBimg').onclick = () => { shareImageFlow(); };

        document.getElementById('retryBtn').onclick = () => { who=null; mode=null; qs=[]; answers={}; index=0; renderStart(); };
        window.scrollTo({top:0, behavior:'smooth'});
      }

      /* ================ 各特性Lvバッジ ================ */
      function renderAxisLevelBadges(radar){
        return radar.map(d=>{
          const mode = d.hyper>d.hypo ? '過敏' : (d.hypo>d.hyper ? '鈍麻' : '同程度');
          const lv = pctToLv(Math.max(d.hyper, d.hypo)); // 0–99
          return `
            <div class="level-item">
              <div><strong>${d.axis}</strong><span class="chip">${mode}</span></div>
              <div class="lv">Lv${String(lv).padStart(2,'0')}</div>
            </div>
          `;
        }).join('');
      }

      /* ================ ロジック ================ */
      function pickQuestions(mode){
        const count = MODE_MAP[mode];
        const byAxis = Object.fromEntries(AXES.map(a=>[a.key,[]]));
        BANK.forEach(q=>byAxis[q.axis].push(q));
        const perAxisBase = Math.floor(count/AXES.length);
        const remainder = count%AXES.length;
        const out=[];
        AXES.forEach((ax,i)=>{
          const take = perAxisBase + (i<remainder?1:0);
          const pool = byAxis[ax.key];
          const hypers = pool.filter(q=>q.trait==='hyper');
          const hypos  = pool.filter(q=>q.trait==='hypo');
          let h=0,y=0;
          for(let k=0;k<take;k++){
            if(h<=y && h<hypers.length) out.push(hypers[h++]);
            else if(y<hypos.length) out.push(hypos[y++]);
            else if(h<hypers.length) out.push(hypers[h++]);
          }
        });
        return out;
      }

      // パーセンテージ(0–100)→Lv(0–99)
      function pctToLv(p){ return Math.min(99, Math.max(0, Math.floor(p*0.99))); }

      // スコア計算
      function calcScores(questions, answers){
        const sums = Object.fromEntries(AXES.map(a=>[a.key,{h:0,y:0,hc:0,yc:0}]));
        questions.forEach(q=>{
          const v = answers[q.id];
          if(v==null) return;
          if(q.trait==='hyper'){sums[q.axis].h+=v; sums[q.axis].hc++;}
          else {sums[q.axis].y+=v; sums[q.axis].yc++;}
        });
        const radar = AXES.map(ax=>{
          const maxH = Math.max(1, sums[ax.key].hc*4);
          const maxY = Math.max(1, sums[ax.key].yc*4);
          const hyper = Math.round((sums[ax.key].h/maxH)*100);
          const hypo  = Math.round((sums[ax.key].y/maxY)*100);
          return { axis: ax.label, axisKey: ax.key, hyper, hypo };
        });

        const hyperAvg = Math.round(radar.reduce((a,d)=>a+d.hyper,0)/radar.length);
        const hypoAvg  = Math.round(radar.reduce((a,d)=>a+d.hypo,0)/radar.length);
        const maxAny   = Math.max(...radar.map(d=>Math.max(d.hyper,d.hypo)));
        const diff     = Math.abs(hyperAvg - hypoAvg);
        const EPS = 6;   // 傾向差のしきい値（%）
        const LOW = 20;  // 低強度

        let overall;
        if (maxAny <= LOW || diff <= EPS) {
          overall = 'balanced';
        } else {
          overall = (hyperAvg > hypoAvg) ? 'hyper' : 'hypo';
        }

        // 代表軸
        let dominantKey = radar[0].axisKey, best=-1;
        radar.forEach(d=>{ const m=Math.max(d.hyper,d.hypo); if(m>best){best=m; dominantKey=d.axisKey;} });

        // Lv計算（0–99）
        const dom = radar.find(r=>r.axisKey===dominantKey);
        const lvDominant = pctToLv(Math.max(dom.hyper, dom.hypo));
        const lvBalanced = pctToLv(100 - maxAny);

        return { radar, hyperAvg, hypoAvg, overall, dominant: dominantKey, maxAny, lvDominant, lvBalanced };
      }

      /* ================ 共有ビュー描画 ================ */
      function renderResultFromPayload(payload){
        const { overall, dominant, axisLabel, title, radar, level, lvLabel } = payload;
        const roleImg = (overall==='balanced')
          ? IMAGES.balanced
          : (overall==='hyper' ? IMAGES.rolesHyper[dominant] : IMAGES.rolesHypo[dominant]);
        app.innerHTML = `
          <div class="grid">
            <div class="card center">
              <h2>結果（共有）</h2>
              ${roleImg ? `<img class="role" src="${roleImg}" alt="${title}">` : ``}
              <div style="font-weight:700; margin-top:6px">称号：${title}</div>
              <div class="small">${lvLabel||'Lv'}：<span style="font-weight:700">Lv${String(level??'--').padStart(2,'0')}</span></div>
              <div style="height:360px; margin:14px auto 0; display:flex; align-items:center; justify-content:center; max-width:560px;">
                <canvas id="radar"></canvas>
              </div>
              <div style="margin-top:10px">
                <button id="retryBtn2" class="button primary">自分でも調べる</button>
              </div>
            </div>
            <div class="card">
              <h3>各特性のレベル</h3>
              <div class="level-grid">
                ${renderAxisLevelBadges(radar)}
              </div>
            </div>
          </div>`;
        const ctx = document.getElementById('radar');
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: radar.map(d=>d.axis),
            datasets: [
              { label:'過敏', data: radar.map(d=>d.hyper), fill:true, borderColor:'#111827', backgroundColor:'rgba(17,24,39,0.35)' },
              { label:'鈍麻', data: radar.map(d=>d.hypo),  fill:true, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.25)' },
            ]
          },
          options: { scales:{ r:{ suggestedMin:0, suggestedMax:100 } }, plugins:{ legend:{position:'bottom'} } }
        });
        document.getElementById('retryBtn2').onclick=()=>{who=null; mode=null; renderStart();};
      }

      /* ================ 共有URL/画像 ================ */
      function buildShareUrl(obj){
        const json = JSON.stringify(obj);
        const b64 = btoa(unescape(encodeURIComponent(json)))
                    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
        const base = location.origin + location.pathname.replace(/index\.html$/,'');
        return `${base}?r=${b64}`;
      }
      function parseSharePayload(){
        const m = location.search.match(/[?&]r=([^&]+)/);
        if(!m) return null;
        try{
          const b64 = m[1].replace(/-/g,'+').replace(/_/g,'/');
          const pad = b64.length%4===2?'==':(b64.length%4===3?'=':'');
          const json = decodeURIComponent(escape(atob(b64+pad)));
          return JSON.parse(json);
        }catch{ return null; }
      }

      async function buildShareImage({ titleText, axisLabel, leaning, radarCanvas, roleImgSrc }){
        const W=1080, H=1080;
        const c = document.createElement('canvas'); c.width=W; c.height=H;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W,H);

        ctx.fillStyle = '#0f172a';
        ctx.font = 'bold 56px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
        ctx.fillText('KANKAKUクエスト', 60, 100);
        ctx.font = '28px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
        ctx.fillText('あなたの感覚ジョブ診断', 60, 145);

        ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 2;
        roundRect(ctx, 60, 180, W-120, H-260, 24); ctx.stroke();

        ctx.font = 'bold 44px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
        ctx.fillText(`称号：${titleText}`, 90, 250);

        ctx.font = '28px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
        ctx.fillText(`特徴：${axisLabel}／傾向：${leaning}`, 90, 295);

        if(roleImgSrc){
          const roleImg = await loadImage(roleImgSrc);
          const roleBoxW = 360, roleBoxH = 360;
          const roleX = 100, roleY = 330;
          const {dw:riw, dh:rih} = fitContain(roleImg.width, roleImg.height, roleBoxW, roleBoxH);
          ctx.drawImage(roleImg, roleX + (roleBoxW-riw)/2, roleY + (roleBoxH-rih)/2, riw, rih);
        }

        const radarDataUrl = radarCanvas.toDataURL('image/png');
        const radarImg = await loadImage(radarDataUrl);
        const radarW=460, radarH=460, radarX=520, radarY=300;
        ctx.drawImage(radarImg, radarX, radarY, radarW, radarH);

        ctx.font = '24px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
        ctx.fillStyle = '#334155';
        ctx.fillText('#KANKAKUクエスト  #感覚過敏', 90, 730);

        ctx.font = '20px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
        ctx.fillStyle = '#64748b';
        ctx.fillText('by MANAKURO', 90, 1010);

        const blob = await new Promise(res => c.toBlob(b => res(b), 'image/png'));
        const url  = URL.createObjectURL(blob);
        return { blob, url };
      }

      async function shareOrDownloadImage(blob, filename, text){
        const file = new File([blob], filename, {type:'image/png'});
        if(navigator.canShare && navigator.canShare({ files:[file] })){
          try{
            await navigator.share({ files:[file], text });
            return;
          }catch(e){ /* キャンセル等は無視してDLにフォールバック */ }
        }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        try{
          await navigator.clipboard.writeText(text);
          alert('シェア用画像を保存しました。投稿文もコピー済みです。各SNSで画像を添付して貼り付けてください。');
        }catch{
          alert('シェア用画像を保存しました。投稿文は手動でコピーしてください。');
        }
      }

      function roundRect(ctx, x, y, w, h, r){
        ctx.beginPath();
        ctx.moveTo(x+r, y);
        ctx.arcTo(x+w, y,   x+w, y+h, r);
        ctx.arcTo(x+w, y+h, x,   y+h, r);
        ctx.arcTo(x,   y+h, x,   y,   r);
        ctx.arcTo(x,   y,   x+w, y,   r);
        ctx.closePath();
      }
      function fitContain(sw, sh, dw, dh){
        const s = Math.min(dw/sw, dh/sh);
        return { dw: Math.round(sw*s), dh: Math.round(sh*s) };
      }
      function loadImage(src){
        return new Promise((ok, ng)=>{
          const i = new Image(); i.crossOrigin='anonymous'; i.onload=()=>ok(i); i.onerror=ng; i.src = src;
        });
      }

      function renderAxisFeedback(radar){
        const scored = radar.map(d=>({ key:d.axisKey, label:d.axis, hyper:d.hyper, hypo:d.hypo }));
        const picks = scored.filter(s=>Math.max(s.hyper,s.hypo)>=60)
                            .sort((a,b)=>Math.max(b.hyper,b.hypo)-Math.max(a.hyper,a.hypo));
        const list = (picks.length? picks: scored.sort((a,b)=>Math.max(b.hyper,b.hypo)-Math.max(a.hyper,a.hypo)).slice(0,3));
        return list.map(s=>{
          const mode = s.hyper> s.hypo ? 'hyper' : (s.hypo> s.hyper? 'hypo':'mix');
          const book = COMMENT_BOOK[s.key];
          const strong = mode==='mix'? [...book.hyper.strong,...book.hypo.strong].slice(0,2) : book[mode].strong;
          const challenge = mode==='mix'? [...book.hyper.challenge,...book.hypo.challenge].slice(0,2) : book[mode].challenge;
          const tips = mode==='mix'? [...book.hyper.tips,...book.hypo.tips].slice(0,3) : book[mode].tips;
          return `
            <div class="card">
              <h3>${s.label}</h3>
              <div class="small muted">過敏:${s.hyper}% / 鈍麻:${s.hypo}%</div>
              <div class="cols" style="margin-top:8px">
                <div><div style="font-weight:600; margin-bottom:6px">得意なこと（強み）</div><ul>${strong.map(x=>`<li>${x}</li>`).join('')}</ul></div>
                <div><div style="font-weight:600; margin-bottom:6px">苦手になりやすいこと</div><ul>${challenge.map(x=>`<li>${x}</li>`).join('')}</ul></div>
                <div><div style="font-weight:600; margin-bottom:6px">対処法のヒント</div><ul>${tips.map(x=>`<li>${x}</li>`).join('')}</ul></div>
              </div>
            </div>`;
        }).join('');
      }

      function renderLowOverallCard(){
        return `
          <div class="card">
            <h3>今回のまとめ</h3>
            <p class="muted">全体的に大きな偏りは見られませんでした。日によって「少し気になる」「今日は平気」など、ゆるやかな変化があるタイプかもしれません。</p>
            <ul>
              <li>困りごとが少ない時は、そのままの環境でOK</li>
              <li>疲れている日は、音や光など一つだけでもコントロールできると楽に</li>
              <li>「しんどさログ」をつけると自分の傾向が見つけやすい</li>
            </ul>
          </div>
        `;
      }

      /* ================ 初期化（ロゴでトップ/共有リンク対応） ================ */
      window.addEventListener('DOMContentLoaded', () => {
        const btnTop = document.getElementById('seminarBtnTop');
        if (btnTop) btnTop.href = SEMINAR_URL;
        document.getElementById('homeLink')?.addEventListener('click',(e)=>{ e.preventDefault(); who=null; mode=null; qs=[]; answers={}; index=0; renderStart(); });

        const payload = parseSharePayload();
        if(payload) renderResultFromPayload(payload);
        else renderStart();
      });
    </script>
  </body>
</html>
